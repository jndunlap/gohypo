{{template "base.html" .}}

{{define "content"}}
<div class="max-w-7xl mx-auto px-6 py-6">
    <div class="mb-6 flex items-center justify-between border-b border-cold-steel pb-4">
        <div>
            <h1 class="tactical-header text-2xl tracking-[0.2em]">Registry Vitality Report</h1>
            <p class="text-[11px] text-ghost-gray mt-2 font-mono uppercase">Registry Entropy Audit // Global_Signal_Strength: {{if .AverageEntropy}}{{printf "%.2f" .AverageEntropy}}{{else}}0.00{{end}}</p>
        </div>
        <div class="flex gap-3">
            <div class="bg-obsidian border border-cold-steel px-4 py-2 min-w-[140px]">
                <div class="tactical-header text-[8px] text-ghost-gray mb-1">ADMISSIBLE_VECTORS</div>
                <div class="computed-value text-sm text-hyper-lime">{{.AdmissibleCount}} VARS</div>
            </div>
            <div class="bg-obsidian border border-cold-steel px-4 py-2 min-w-[140px]">
                <div class="tactical-header text-[8px] text-ghost-gray mb-1">INADMISSIBLE_VECTORS</div>
                <div class="computed-value text-sm text-crimson-ghost">{{.RejectedCount}} VARS</div>
            </div>
        </div>
    </div>

    <!-- Entropy Heatmap -->
    <div class="mb-6 discovery-dossier relative p-6">
        <div class="hash-watermark uppercase">SIGNAL_DENSITY_HEATMAP // Registry_ID: {{.RegistryHash}}</div>
        <div class="tactical-header text-[10px] text-ghost-gray mb-4">Vector Signal Intensity Overview</div>
        
        <div class="h-48 flex items-end gap-1.5 px-6 py-2 border-l border-b border-cold-steel relative bg-gradient-to-b from-void/50 to-void/80">
            <!-- Y-Axis Labels -->
            <div class="absolute -left-14 top-0 h-full flex flex-col justify-between text-[9px] font-mono text-ghost-gray py-2">
                <span>1.0</span>
                <span>0.5</span>
                <span>0.0</span>
            </div>
            
            <!-- Grid Lines -->
            <div class="absolute inset-0 flex flex-col justify-between pointer-events-none">
                <div class="border-t border-cold-steel/30"></div>
                <div class="border-t border-cold-steel/30"></div>
                <div class="border-t border-cold-steel/30"></div>
            </div>
            
            {{if .EntropyData}}
            {{range .EntropyData}}
            {{$barHeight := max .entropyPercent 8.0}}
            {{$entropy := .entropy}}
            <div class="flex-1 relative group cursor-pointer" style="height: {{printf "%.0f" $barHeight}}%">
                <!-- Bar with gradient -->
                <div class="absolute bottom-0 left-0 right-0 rounded-t transition-all duration-300 group-hover:brightness-110 group-hover:shadow-lg" 
                     style="height: 100%;
                            {{if gt $entropy 0.7}}
                            background: linear-gradient(to top, rgba(0, 255, 65, 0.9), rgba(0, 255, 65, 0.6));
                            box-shadow: 0 -2px 8px rgba(0, 255, 65, 0.4);
                            {{else if gt $entropy 0.4}}
                            background: linear-gradient(to top, rgba(46, 91, 255, 0.9), rgba(46, 91, 255, 0.6));
                            box-shadow: 0 -2px 8px rgba(46, 91, 255, 0.4);
                            {{else}}
                            background: linear-gradient(to top, rgba(255, 0, 60, 0.9), rgba(255, 0, 60, 0.6));
                            box-shadow: 0 -2px 8px rgba(255, 0, 60, 0.4);
                            {{end}}">
                    <!-- Bar highlight -->
                    <div class="absolute top-0 left-0 right-0 h-1/3 bg-white/20 rounded-t"></div>
                </div>
                
                <!-- Tooltip -->
                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-3 hidden group-hover:block z-50 pointer-events-none">
                    <div class="bg-obsidian border border-cold-steel px-3 py-2 shadow-lg rounded">
                        <div class="computed-value text-[11px] text-ghost-white font-semibold mb-1">{{.variable}}</div>
                        <div class="flex items-center gap-2">
                            <span class="computed-value text-[10px] text-ghost-gray">ENTROPY:</span>
                            <span class="computed-value text-[10px] {{if gt $entropy 0.7}}text-hyper-lime{{else if gt $entropy 0.4}}text-electric-cobalt{{else}}text-crimson-ghost{{end}} font-mono">{{printf "%.3f" $entropy}}</span>
                        </div>
                        <div class="mt-1 pt-1 border-t border-cold-steel/30">
                            <span class="computed-value text-[9px] text-ghost-gray">INTENSITY: {{printf "%.1f" $barHeight}}%</span>
                        </div>
                    </div>
                    <!-- Tooltip arrow -->
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-cold-steel"></div>
                </div>
                
                <!-- Variable label at bottom -->
                <div class="absolute -bottom-5 left-1/2 -translate-x-1/2 text-[7px] font-mono text-ghost-gray/60 truncate max-w-full px-0.5">
                    {{printf "%.8s" .variable}}
                </div>
            </div>
            {{end}}
            {{else}}
            <div class="flex-1 flex items-center justify-center h-full">
                <div class="text-center">
                    <div class="computed-value text-sm text-ghost-gray mb-2">No entropy data available</div>
                    <div class="tactical-header text-[9px] text-ghost-gray/60">Run profile stage to generate data</div>
                </div>
            </div>
            {{end}}
        </div>
        
        <div class="flex justify-between items-center mt-6 px-6">
            <span class="tactical-header text-[9px] text-ghost-gray">VECTOR_RANGE_001</span>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-hyper-lime/60 rounded"></div>
                    <span class="tactical-header text-[8px] text-ghost-gray">HIGH (â‰¥0.7)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-electric-cobalt/60 rounded"></div>
                    <span class="tactical-header text-[8px] text-ghost-gray">MED (0.4-0.7)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-crimson-ghost/60 rounded"></div>
                    <span class="tactical-header text-[8px] text-ghost-gray">LOW (&lt;0.4)</span>
                </div>
            </div>
            <span class="tactical-header text-[9px] text-ghost-gray">VECTOR_RANGE_{{if .EntropyData}}{{printf "%03d" (len .EntropyData)}}{{else}}000{{end}}</span>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Left Column: Forensic Fingerprint -->
        <div class="lg:col-span-1">
            <div class="discovery-dossier p-6">
                <h3 class="tactical-header text-[11px] tracking-widest mb-4">FORENSIC FINGERPRINT DOSSIER</h3>
                <div class="space-y-3">
                    <div>
                        <div class="tactical-header text-[9px] text-ghost-gray mb-1">EXECUTION FINGERPRINT</div>
                        <div class="computed-value text-[10px] text-ghost-white font-mono">sha256:{{printf "%.16s" .RegistryHash}}...</div>
                    </div>
                    <div>
                        <div class="tactical-header text-[9px] text-ghost-gray mb-1">REGISTRY HASH</div>
                        <div class="computed-value text-[10px] text-ghost-gray font-mono">{{.RegistryHash}}</div>
                    </div>
                    <div>
                        <div class="computed-value text-[9px] text-hyper-lime uppercase">REPLAY_LO_MAPPING</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Vitality Matrix -->
        <div class="lg:col-span-2">
            <section class="registry-container overflow-hidden">
                <div class="border-b border-cold-steel px-4 py-3 flex items-center justify-between">
                    <h3 class="tactical-header text-[11px] tracking-widest">Entity Vitality Matrix (Forensic Audit)</h3>
                    <span class="computed-value text-[9px] text-ghost-gray uppercase tracking-tighter">Sort_Order: SIGNAL_DEGRADATION_DESC</span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full forensic-table border-collapse">
                    <thead>
                        <tr class="bg-void">
                            <th class="text-left py-3 px-4 text-[9px]">Entity_Identifier</th>
                            <th class="text-left text-[9px] px-2">Variable_Pulse</th>
                            <th class="text-right text-[9px] px-2">Missingness</th>
                            <th class="text-right text-[9px] px-2">Variance</th>
                            <th class="text-right text-[9px] px-2">N-Count</th>
                            <th class="text-left px-4 text-[9px]">Diagnostic_Code</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/[0.03]">
                        {{if .VariableProfiles}}
                        {{range .VariableProfiles}}
                        <tr class="group hover:bg-white/[0.02] transition-colors border-b border-white/[0.03]">
                            <td class="py-3 px-4">
                                <div class="flex flex-col">
                                    <span class="computed-value text-sm text-ghost-white group-hover:text-hyper-lime transition-colors">{{.VariableKey}}</span>
                                    <span class="computed-value text-[8px] text-ghost-gray mt-1">PTR: 0x{{printf "%.8s" .VariableKey}}</span>
                                </div>
                            </td>
                            <td class="py-3 px-2">
                                <div class="flex items-end gap-0.5 h-6 w-20 px-1 border-l border-cold-steel/30">
                                    {{range .Pulse}}
                                    {{$pulseHeight := mul . 100}}
                                    <div class="flex-1 {{if gt . 0.7}}bg-hyper-lime{{else if gt . 0.4}}bg-electric-cobalt{{else}}bg-crimson-ghost{{end}} opacity-40 group-hover:opacity-80 transition-opacity" style="height: {{printf "%.0f" $pulseHeight}}%"></div>
                                    {{end}}
                                </div>
                            </td>
                            <td class="text-right py-3 px-2">
                                <span class="computed-value text-xs {{if gt .MissingRate 0.3}}text-crimson-ghost{{else}}text-ghost-white{{end}}">{{printf "%.1f%%" .MissingRatePercent}}</span>
                            </td>
                            <td class="text-right py-3 px-2">
                                <span class="computed-value text-xs text-ghost-gray">{{printf "%.4g" .Variance}}</span>
                            </td>
                            <td class="text-right py-3 px-2">
                                <span class="computed-value text-xs text-ghost-gray">{{.SampleSize}}</span>
                            </td>
                            <td class="py-3 px-4">
                                <div class="flex flex-wrap gap-2">
                                    {{if .Flags}}
                                        {{range .Flags}}
                                        <div class="flex flex-col">
                                            <span class="computed-value text-[9px] px-2 py-0.5 bg-crimson-ghost/10 text-crimson-ghost border border-crimson-ghost/30 uppercase tracking-tighter">{{.}}</span>
                                            {{if eq . "HIGH_MISSING"}}
                                            <span class="text-[7px] text-crimson-ghost/60 uppercase mt-0.5">Exclusion: Sub-Threshold Information Gain</span>
                                            {{else if eq . "LOW_VARIANCE"}}
                                            <span class="text-[7px] text-crimson-ghost/60 uppercase mt-0.5">Exclusion: Zero-Point Stagnation</span>
                                            {{else if eq . "LOW_N"}}
                                            <span class="text-[7px] text-crimson-ghost/60 uppercase mt-0.5">Exclusion: Insufficient Sample Breadth</span>
                                            {{end}}
                                        </div>
                                        {{end}}
                                    {{else}}
                                        <div class="flex flex-col">
                                            <span class="computed-value text-[9px] px-2 py-0.5 bg-hyper-lime/10 text-hyper-lime border border-hyper-lime/30 uppercase tracking-tighter">VAL_SIGNAL</span>
                                            <span class="text-[7px] text-hyper-lime/60 uppercase mt-0.5">Status: Admissible for Extraction</span>
                                        </div>
                                    {{end}}
                                </div>
                            </td>
                        </tr>
                        {{end}}
                        {{else}}
                        <tr>
                            <td colspan="6" class="py-8 text-center">
                                <div class="computed-value text-sm text-ghost-gray">No variable profiles available</div>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Footer Audit Pulse -->
    <div class="mt-6 flex items-center justify-between border-t border-cold-steel pt-6">
        <div class="flex gap-8">
            <div class="flex flex-col">
                <span class="tactical-header text-[8px] text-ghost-gray mb-1 uppercase">Extraction Confidence</span>
                <span class="computed-value text-lg text-hyper-lime">{{if .AverageEntropy}}{{printf "%.2f" .AverageEntropy}}{{else}}0.00{{end}}</span>
            </div>
            <div class="flex flex-col">
                <span class="tactical-header text-[8px] text-ghost-gray mb-1 uppercase">Registry Integrity</span>
                <span class="computed-value text-lg text-ghost-white">STABLE</span>
            </div>
        </div>
        <button class="tactical-button text-[10px] px-8" hx-post="/api/registry/re-audit" hx-target="body">Execute Re-Audit Pipeline</button>
    </div>
</div>
{{end}}
