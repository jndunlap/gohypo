{{template "base.html" .}}

{{define "content"}}
<!-- Professional Research Laboratory -->
<div class="min-h-screen bg-white">
    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Header Section -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">{{.DatasetInfo.name}}</h1>
                        <p class="text-gray-600 mt-1">{{len .FieldStats}} variables ‚Ä¢ {{.FieldCount}} total fields</p>
                    </div>

                    <!-- Data Quality Indicator -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-700">Data Quality:</span>
                        <span class="status-badge {{if gt .DatasetInfo.missingnessOverall 0.1}}status-rejected{{else if gt .DatasetInfo.missingnessOverall 0.05}}status-pending{{else}}status-validated{{end}}">
                            {{printf "%.1f" (mul .DatasetInfo.missingnessOverall 100)}}% missing
                        </span>
                    </div>
                </div>

                <!-- Primary Action -->
                <button class="btn-primary"
                        hx-post="/api/research/initiate"
                        hx-target="#hypothesis-cards-container"
                        hx-swap="innerHTML"
                        hx-indicator="#research-spinner"
                        onclick="initiateResearch()">
                    <span id="research-spinner" class="spinner hidden mr-2"></span>
                    Generate Research
                </button>
            </div>
        </header>

        <!-- Variable Inventory Section -->
        <section class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Variable Inventory</h2>
                <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                    {{len .FieldStats}} variables
                </span>
            </div>

            <div class="grid-auto-fit">
                {{range .FieldStats}}
                <div class="card p-4">
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="font-semibold text-gray-900 truncate text-sm" title="{{.Name}}">{{.Name}}</h3>
                        <span class="status-badge {{if eq .Type "numeric"}}status-validated{{else}}status-pending{{end}} text-xs">
                            {{if eq .Type "numeric"}}NUM{{else}}CAT{{end}}
                        </span>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="metric-label">Missing</span>
                            <span class="metric-value {{if gt .MissingRate 0.05}}text-error{{else}}text-success{{end}}">
                                {{.MissingRatePct}}%
                            </span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="metric-label">Variance</span>
                            <span class="metric-value">{{printf "%.2f" .Variance}}</span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="metric-label">Unique</span>
                            <span class="metric-value">{{.UniqueCount}}</span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="metric-label">Relationships</span>
                            <span class="metric-value text-accent">{{.InRelationships}}</span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="metric-label">Strongest Corr</span>
                            <span class="metric-value {{if and (gt .TotalRelsAnalyzed 0) (gt .StrongestCorr 0.0)}}text-success{{else if and (gt .TotalRelsAnalyzed 0) (lt .StrongestCorr 0.0)}}text-error{{else}}text-gray-500{{end}}">
                                {{if gt .TotalRelsAnalyzed 0}}{{printf "%.2f" .StrongestCorr}}{{else}}‚Äî{{end}}
                            </span>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
        </section>

        <!-- Industry Context Section -->
        <section class="mb-8" id="industry-context-section" style="display: none;">
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-medium text-blue-800">Industry Context</h3>
                        <p class="mt-1 text-sm text-blue-700" id="industry-context-text">Loading industry context...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Research Hypotheses Section -->
        <main class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Research Hypotheses</h2>
                <div class="flex items-center space-x-4 text-sm text-gray-600">
                    <span id="hypothesis-count">0 hypotheses</span>
                    <span id="research-status">Ready</span>
                </div>
            </div>

            <!-- Hypothesis Cards Container -->
            <div id="hypothesis-cards-container">
                <!-- Cards will be populated by HTMX -->
                <div class="text-center py-12 text-gray-500">
                    <div class="text-2xl mb-4">üî¨</div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Research Laboratory</h3>
                    <p>Click "Generate Research" to create hypothesis cards</p>
                </div>
            </div>
        </main>

        <!-- Rejected Hypotheses Section -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Rejected Hypotheses</h2>
            <div id="rejected-hypotheses-container" class="grid-responsive opacity-60">
                <!-- Rejected hypothesis cards will appear here with ghosted styling -->
                <div class="col-span-full text-center py-8 text-gray-400">
                    <p>No rejected hypotheses yet</p>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Research Status Indicator (Hidden, for HTMX updates) -->
<div id="research-status" style="display: none;"></div>

<script>
// Toggle evidence drawer for hypothesis cards
function toggleEvidenceDrawer(hypothesisId) {
    const drawer = document.getElementById(`drawer-${hypothesisId}`);
    const button = drawer.previousElementSibling.querySelector('.expand-toggle');

    if (drawer.style.display === 'none' || drawer.style.display === '') {
        drawer.style.display = 'block';
        button.innerHTML = 'Review Science ‚ñ≤';
    } else {
        drawer.style.display = 'none';
        button.innerHTML = 'Review Science ‚ñº';
    }
}

// Initiate research function with enhanced loading animation
function initiateResearch() {
    const btn = document.querySelector('.btn-primary');
    const spinner = document.getElementById('research-spinner');
    const status = document.getElementById('research-status');
    const hypothesisContainer = document.getElementById('hypothesis-cards-container');
    const hypothesisCount = document.getElementById('hypothesis-count');

    // Disable button and show loading state
    if (btn) {
        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-not-allowed');
        const originalText = btn.innerHTML;
        btn.setAttribute('data-original-text', originalText);
        btn.innerHTML = '<span class="spinner mr-2"></span>Analyzing Data...';
    }

    // Show loading animation in the hypothesis container
    if (hypothesisContainer) {
        hypothesisContainer.innerHTML = `
            <div class="text-center py-16">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-accent rounded-full mb-6">
                    <div class="spinner w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Generating Research Hypotheses</h3>
                <p class="text-gray-600 mb-4">Analyzing your dataset and formulating scientific questions...</p>
                <div class="flex items-center justify-center space-x-2 text-sm text-gray-500">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-accent rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-accent rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-accent rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            </div>
        `;
    }

    // Update status
    if (status) {
        status.textContent = 'Analyzing data...';
    }

    // Update hypothesis count
    if (hypothesisCount) {
        hypothesisCount.textContent = 'Analyzing...';
    }

    // Start polling for status updates
    startResearchPolling();
}

// Research polling variables
let researchPollingInterval = null;

// Start polling for research status updates
function startResearchPolling() {
    if (researchPollingInterval) {
        clearInterval(researchPollingInterval);
    }

    researchPollingInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/research/status');
            const status = await response.json();

            updateResearchStatus(status);
        } catch (error) {
            console.error('Error polling research status:', error);
        }
    }, 2000); // Poll every 2 seconds
}

// Stop polling
function stopResearchPolling() {
    if (researchPollingInterval) {
        clearInterval(researchPollingInterval);
        researchPollingInterval = null;
    }
}

// Update research status in UI
function updateResearchStatus(status) {
    const statusElement = document.getElementById('research-status');
    const hypothesisCount = document.getElementById('hypothesis-count');
    const btn = document.querySelector('.btn-primary');

    if (statusElement) {
        switch (status.state) {
            case 'analyzing':
                statusElement.textContent = 'Analyzing with AI...';
                if (btn) btn.innerHTML = '<span class="spinner mr-2"></span>Analyzing Data...';
                break;
            case 'validating':
                statusElement.textContent = 'Validating hypotheses...';
                if (btn) btn.innerHTML = '<span class="spinner mr-2"></span>Validating...';
                break;
            case 'complete':
                statusElement.textContent = 'Research complete';
                stopResearchPolling();
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    btn.innerHTML = 'Generate Research';
                }
                // Load the completed hypotheses
                loadCompletedHypotheses();
                break;
            case 'error':
                statusElement.textContent = `Error: ${status.error || 'Unknown error'}`;
                stopResearchPolling();
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    btn.innerHTML = 'Try Again';
                }
                break;
            default:
                statusElement.textContent = 'Ready';
        }
    }

    // Update hypothesis count
    if (hypothesisCount && status.completed_count !== undefined) {
        if (status.state === 'complete') {
            hypothesisCount.textContent = `${status.completed_count} hypotheses`;
        } else {
            hypothesisCount.textContent = `${status.completed_count || 0} generated`;
        }
    }
}

// Load completed hypotheses
async function loadCompletedHypotheses() {
    try {
        const response = await fetch('/api/research/ledger?limit=50', {
            headers: {
                'HX-Request': 'true',
                'HX-Target': 'hypothesis-cards-container',
                'HX-Trigger': 'research-complete'
            }
        });
        const html = await response.text();
        const container = document.getElementById('hypothesis-cards-container');
        if (container) {
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading hypotheses:', error);
        // Show error state
        const container = document.getElementById('hypothesis-cards-container');
        if (container) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12 text-red-500">
                    <div class="text-2xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Hypotheses</h3>
                    <p>Please try again or check the console for details.</p>
                </div>
            `;
        }
    }
}

// Load industry context on page load
async function loadIndustryContext() {
    try {
        const response = await fetch('/api/research/industry-context');
        if (!response.ok) {
            console.log('[Research UI] Industry context not available');
            return;
        }
        const data = await response.json();
        if (data.industry_context && data.industry_context.trim() !== '') {
            const section = document.getElementById('industry-context-section');
            const text = document.getElementById('industry-context-text');
            if (section && text) {
                text.textContent = data.industry_context;
                section.style.display = 'block';
            }
        }
    } catch (error) {
        console.error('[Research UI] Failed to load industry context:', error);
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Load industry context async on page load
    loadIndustryContext();
});
</script>
{{end}}