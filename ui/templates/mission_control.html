<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - GoHypo Research Laboratory</title>
    <link href="https://cdn.tailwindcss.com/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
    <link href="/static/css/research.css" rel="stylesheet">
    <style>
        .layer-card {
            transition: all 0.3s ease;
        }
        .layer-card.active {
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        .layer-card.error {
            border-color: rgb(239 68 68);
            background: linear-gradient(to br, rgb(254 242 242), rgb(254 226 226));
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
        .hypothesis-card {
            transition: all 0.3s ease;
        }
        .hypothesis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .event-log {
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Mission Control</h1>
                        <p class="text-blue-100">GoHypo Autonomous Research Laboratory</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-400 rounded-full status-indicator"></div>
                        <span class="text-sm">Connected</span>
                    </div>
                    <button onclick="startNewSession()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors">
                        New Research Session
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Session Overview -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">Session: <span id="session-id" class="text-blue-600">Initializing...</span></h2>
                <div class="flex items-center space-x-2">
                    <span id="session-status" class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">Loading</span>
                    <span id="uptime" class="text-sm text-gray-500">00:00:00</span>
                </div>
            </div>

            <!-- Overall Progress -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-semibold text-gray-700">Research Progress</span>
                    <span id="overall-progress" class="text-2xl font-bold text-blue-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progress-bar" class="progress-bar bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Layer Status Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div id="layer-0" class="layer-card bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">L0</div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-200 text-blue-800">Scout</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Data Ingestion</h3>
                <p class="text-sm text-gray-600 mb-4">Pattern detection and statistical analysis of raw data</p>
                <div class="text-xs text-gray-500">Status: <span class="layer-status">Initializing</span></div>
            </div>

            <div id="layer-1" class="layer-card bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">L1</div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-200 text-green-800">Scientist</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Hypothesis Generation</h3>
                <p class="text-sm text-gray-600 mb-4">LLM-driven research directive creation</p>
                <div class="text-xs text-gray-500">Status: <span class="layer-status">Waiting</span></div>
            </div>

            <div id="layer-2" class="layer-card bg-gradient-to-br from-yellow-50 to-yellow-100 border border-yellow-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">L2</div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-200 text-yellow-800">Referee</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Validation Gauntlet</h3>
                <p class="text-sm text-gray-600 mb-4">Tri-Gate statistical validation process</p>
                <div class="text-xs text-gray-500">Status: <span class="layer-status">Waiting</span></div>
            </div>

            <div id="layer-3" class="layer-card bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">L3</div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-200 text-purple-800">Gateway</span>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Success Persistence</h3>
                <p class="text-sm text-gray-600 mb-4">Economic validation and database storage</p>
                <div class="text-xs text-gray-500">Status: <span class="layer-status">Waiting</span></div>
            </div>
        </div>

        <!-- Research Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Hypotheses Panel -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Hypotheses</h2>
                    <div class="flex space-x-4 text-sm">
                        <span class="text-green-600">[PASS] <span id="passed-count">0</span> Passed</span>
                        <span class="text-red-600">[FAIL] <span id="failed-count">0</span> Failed</span>
                        <span class="text-blue-600">[ACTIVE] <span id="active-count">0</span> Active</span>
                    </div>
                </div>

                <div id="hypotheses-container" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p>Waiting for research session to begin...</p>
                    </div>
                </div>
            </div>

            <!-- Event Stream -->
            <div class="bg-gray-900 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-white mb-6">Live Event Stream</h2>
                <div id="event-stream" class="event-log space-y-2 font-mono text-sm">
                    <div class="text-green-400">[LINK] Connected to research session...</div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">Performance Metrics</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600" id="avg-hypothesis-time">0.0s</div>
                    <div class="text-sm text-gray-600">Avg Hypothesis Time</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="validation-rate">0%</div>
                    <div class="text-sm text-gray-600">Success Rate</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600" id="total-processed">0</div>
                    <div class="text-sm text-gray-600">Total Processed</div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        class MissionControl {
            constructor() {
                this.sessionId = null;
                this.eventSource = null;
                this.hypotheses = new Map();
                this.events = [];
                this.startTime = Date.now();
                this.layerStates = {
                    0: 'waiting',
                    1: 'waiting',
                    2: 'waiting',
                    3: 'waiting'
                };

                this.init();
            }

            init() {
                // Get session ID from URL or create new session
                const urlParams = new URLSearchParams(window.location.search);
                this.sessionId = urlParams.get('session');

                if (this.sessionId) {
                    this.connectToSession();
                } else {
                    this.showSessionSelector();
                }

                // Update uptime
                setInterval(() => this.updateUptime(), 1000);
            }

            showSessionSelector() {
                const container = document.getElementById('hypotheses-container');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Start New Research Session</h3>
                        <button onclick="startNewSession()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            ðŸš€ Initiate Research
                        </button>
                    </div>
                `;
            }

            connectToSession() {
                document.getElementById('session-id').textContent = this.sessionId;
                this.connectSSE();
            }

            connectSSE() {
                if (this.eventSource) {
                    this.eventSource.close();
                }

                this.eventSource = new EventSource(`/api/research/sse?session_id=${this.sessionId}`);

                this.eventSource.onopen = () => {
                    this.addEvent('ðŸ”— Connected to research session', 'success');
                    this.updateConnectionStatus(true);
                };

                this.eventSource.onmessage = (event) => {
                    try {
                        const researchEvent = JSON.parse(event.data);
                        this.handleEvent(researchEvent);
                    } catch (e) {
                        console.error('Failed to parse SSE event:', e);
                    }
                };

                this.eventSource.onerror = (error) => {
                    this.addEvent('[ERROR] Connection lost, attempting to reconnect...', 'error');
                    this.updateConnectionStatus(false);
                    setTimeout(() => this.connectSSE(), 3000);
                };
            }

            handleEvent(event) {
                this.events.push(event);
                this.updateProgress(event.progress || 0);

                // Update layer states based on event type
                this.updateLayerState(event);

                // Handle specific event types
                switch (event.event_type) {
                    case 'session_created':
                        this.handleSessionCreated(event);
                        break;
                    case 'layer0_start':
                    case 'layer1_start':
                    case 'layer2_start':
                    case 'layer3_start':
                        this.handleLayerStart(event);
                        break;
                    case 'api_error':
                        this.handleAPIError(event);
                        break;
                    case 'hypothesis_generated':
                        this.handleHypothesisGenerated(event);
                        break;
                    case 'hypothesis_passed':
                    case 'hypothesis_failed':
                        this.handleHypothesisResult(event);
                        break;
                    case 'law_persisted':
                        this.handleLawPersisted(event);
                        break;
                    case 'session_complete':
                        this.handleSessionComplete(event);
                        break;
                }

                this.addEvent(`${event.event_type}: ${event.hypothesis_id || 'N/A'}`, 'info');
            }

            updateProgress(progress) {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('overall-progress');

                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}%`;
            }

            updateLayerState(event) {
                const layerMap = {
                    'layer0_start': 0,
                    'layer1_start': 1,
                    'layer2_start': 2,
                    'layer3_start': 3,
                    'session_complete': 3
                };

                if (layerMap[event.event_type] !== undefined) {
                    const layerId = layerMap[event.event_type];
                    this.layerStates[layerId] = 'active';

                    // Update UI
                    const layerCard = document.getElementById(`layer-${layerId}`);
                    const statusSpan = layerCard.querySelector('.layer-status');

                    layerCard.classList.add('active');
                    statusSpan.textContent = 'Active';

                    // Deactivate previous layers
                    for (let i = 0; i < layerId; i++) {
                        this.layerStates[i] = 'complete';
                        const prevCard = document.getElementById(`layer-${i}`);
                        const prevStatus = prevCard.querySelector('.layer-status');
                        prevCard.classList.remove('active');
                        prevStatus.textContent = 'Complete';
                    }
                }
            }

            handleSessionCreated(event) {
                document.getElementById('session-status').textContent = 'Active';
                document.getElementById('session-status').className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800';
            }

            handleLayerStart(event) {
                this.addEvent(`ðŸŽ¯ ${event.data.phase}: ${event.data.message}`, 'success');
            }

            handleAPIError(event) {
                // Update layer status to show error
                const layerMap = {
                    'layer0_start': 0,
                    'layer1_start': 1,
                    'layer2_start': 2,
                    'layer3_start': 3
                };

                const layerId = layerMap[event.data?.failed_layer] || 1; // Default to layer 1 (Scientist)
                const layerCard = document.getElementById(`layer-${layerId}`);
                const statusSpan = layerCard.querySelector('.layer-status');

                layerCard.classList.add('error');
                layerCard.classList.add('border-red-300');
                statusSpan.textContent = 'API Error';
                statusSpan.className = 'layer-status text-red-600 font-semibold';

                // Show specific error message
                const errorMsg = event.data?.error_message || 'Unknown API error';
                this.addEvent(`[ALERT] API Error: ${errorMsg}`, 'error');

                // Update session status
                document.getElementById('session-status').textContent = 'Error';
                document.getElementById('session-status').className = 'px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800';
            }

            handleHypothesisGenerated(event) {
                const hypothesis = {
                    id: event.hypothesis_id,
                    status: 'validating',
                    businessHypothesis: event.data.business_hypothesis,
                    confidence: null,
                    created: new Date(event.timestamp)
                };

                this.hypotheses.set(event.hypothesis_id, hypothesis);
                this.updateHypothesesDisplay();
                this.updateCounts();
            }

            handleHypothesisResult(event) {
                const hypothesis = this.hypotheses.get(event.hypothesis_id);
                if (hypothesis) {
                    hypothesis.status = event.event_type === 'hypothesis_passed' ? 'passed' : 'failed';
                    hypothesis.confidence = event.data?.p_value || 0;
                    this.updateHypothesesDisplay();
                    this.updateCounts();
                }
            }

            handleLawPersisted(event) {
                this.addEvent(`[VALUE] Law persisted with $${event.data.opportunity_cost} value`, 'success');
            }

            handleSessionComplete(event) {
                document.getElementById('session-status').textContent = 'Complete';
                document.getElementById('session-status').className = 'px-3 py-1 rounded-full text-sm font-semibold bg-purple-100 text-purple-800';

                // Update final metrics
                this.updatePerformanceMetrics(event.data);
                this.addEvent(`[COMPLETE] Session complete! ${event.data.passed}/${event.data.total} hypotheses validated`, 'success');
            }

            updateHypothesesDisplay() {
                const container = document.getElementById('hypotheses-container');
                if (this.hypotheses.size === 0) return;

                const hypothesesHtml = Array.from(this.hypotheses.values())
                    .sort((a, b) => b.created - a.created)
                    .map(hyp => `
                        <div class="hypothesis-card bg-white border rounded-lg p-4 ${this.getHypothesisClasses(hyp.status)}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-mono text-sm text-gray-500">${hyp.id.slice(-8)}</span>
                                <span class="px-2 py-1 rounded text-xs font-semibold ${this.getStatusClasses(hyp.status)}">
                                    ${hyp.status.toUpperCase()}
                                </span>
                            </div>
                            <p class="text-sm mb-2">${hyp.businessHypothesis || 'Processing...'}</p>
                            ${hyp.confidence ? `<div class="text-xs text-gray-500">Confidence: ${(hyp.confidence * 100).toFixed(1)}%</div>` : ''}
                        </div>
                    `).join('');

                container.innerHTML = hypothesesHtml;
            }

            getHypothesisClasses(status) {
                const classes = {
                    'generating': 'border-blue-200 bg-blue-50',
                    'validating': 'border-yellow-200 bg-yellow-50',
                    'passed': 'border-green-200 bg-green-50',
                    'failed': 'border-red-200 bg-red-50'
                };
                return classes[status] || 'border-gray-200 bg-gray-50';
            }

            getStatusClasses(status) {
                const classes = {
                    'generating': 'bg-blue-200 text-blue-800',
                    'validating': 'bg-yellow-200 text-yellow-800',
                    'passed': 'bg-green-200 text-green-800',
                    'failed': 'bg-red-200 text-red-800'
                };
                return classes[status] || 'bg-gray-200 text-gray-800';
            }

            updateCounts() {
                const counts = { passed: 0, failed: 0, active: 0 };
                this.hypotheses.forEach(hyp => {
                    if (hyp.status === 'passed') counts.passed++;
                    else if (hyp.status === 'failed') counts.failed++;
                    else counts.active++;
                });

                document.getElementById('passed-count').textContent = counts.passed;
                document.getElementById('failed-count').textContent = counts.failed;
                document.getElementById('active-count').textContent = counts.active;
            }

            updatePerformanceMetrics(data) {
                if (data.duration_sec && data.total) {
                    const avgTime = data.duration_sec / data.total;
                    document.getElementById('avg-hypothesis-time').textContent = `${avgTime.toFixed(1)}s`;
                }

                if (data.passed && data.total) {
                    const rate = (data.passed / data.total) * 100;
                    document.getElementById('validation-rate').textContent = `${Math.round(rate)}%`;
                }

                document.getElementById('total-processed').textContent = data.total || 0;
            }

            addEvent(message, type = 'info') {
                const eventStream = document.getElementById('event-stream');
                const timestamp = new Date().toLocaleTimeString();

                const colors = {
                    'success': 'text-green-400',
                    'error': 'text-red-400',
                    'warning': 'text-yellow-400',
                    'info': 'text-blue-400'
                };

                const eventDiv = document.createElement('div');
                eventDiv.className = colors[type] || 'text-gray-400';
                eventDiv.innerHTML = `[${timestamp}] ${message}`;

                eventStream.appendChild(eventDiv);
                eventStream.scrollTop = eventStream.scrollHeight;

                // Keep only last 50 events
                while (eventStream.children.length > 50) {
                    eventStream.removeChild(eventStream.firstChild);
                }
            }

            updateConnectionStatus(connected) {
                const statusDiv = document.getElementById('connection-status');
                const indicator = statusDiv.querySelector('.status-indicator');
                const text = statusDiv.querySelector('span:last-child');

                if (connected) {
                    indicator.className = 'w-3 h-3 bg-green-400 rounded-full status-indicator';
                    text.textContent = 'Connected';
                } else {
                    indicator.className = 'w-3 h-3 bg-red-400 rounded-full';
                    text.textContent = 'Disconnected';
                }
            }

            updateUptime() {
                const uptimeSpan = document.getElementById('uptime');
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                uptimeSpan.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Global functions
        function startNewSession() {
            // Trigger HTMX request to start new session
            fetch('/api/research/initiate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.session_id) {
                    // Redirect to mission control with session ID
                    window.location.href = `/mission-control?session=${data.session_id}`;
                }
            })
            .catch(error => {
                console.error('Failed to start session:', error);
                alert('Failed to start research session');
            });
        }

        // Initialize Mission Control when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.missionControl = new MissionControl();
        });
    </script>
</body>
</html>