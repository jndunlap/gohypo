{{/* Hypothesis Row Template - Table Row Design with Tri-Gate Leading Indicator */}}
{{$isUniversalLaw := and .TriGateResult .TriGateResult.OverallPassed}}
<tr class="group hover:bg-gray-50/50 transition-all duration-200" data-hypothesis-id="{{.ID}}">
  <!-- Tri-Gate Leading Indicator -->
  <td class="px-5 py-5 whitespace-nowrap">
    <div class="flex items-center gap-3">
      {{if .RefereeResults}}
        {{/* Show referee status circles */}}
        {{range $index, $result := .RefereeResults}}
          {{if le $index 2}}
            <div class="tri-gate-circle-container flex flex-col items-center" data-referee-index="{{$index}}">
              {{if $result.Passed}}
                <div class="w-8 h-8 rounded-full bg-emerald-50 border border-emerald-200/60 flex items-center justify-center transition-all duration-200 group-hover:scale-105 group-hover:shadow-sm" title="{{$result.GateName}}: PASSED">
                  <svg class="w-4 h-4 text-emerald-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </div>
              {{else}}
                <div class="w-8 h-8 rounded-full bg-red-50 border border-red-200/60 flex items-center justify-center transition-all duration-200 group-hover:scale-105 group-hover:shadow-sm" title="{{$result.GateName}}: FAILED{{if $result.FailureReason}} - {{$result.FailureReason}}{{end}}">
                  <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                </div>
              {{end}}
              <div class="text-[10px] text-gray-600 mt-2 text-center font-medium leading-tight" style="max-width: 64px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                {{$result.GateName}}
              </div>
            </div>
          {{end}}
        {{end}}
        {{/* Fill remaining slots if less than 3 referees */}}
        {{$refereeCount := len .RefereeResults}}
        {{if eq $refereeCount 0}}
          <div class="tri-gate-circle-container flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-gray-50 border border-gray-200/60 flex items-center justify-center transition-all duration-200" title="Awaiting execution">
              <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-[10px] text-gray-500 mt-2 text-center font-medium leading-tight" style="max-width: 64px;">Gate 1</div>
          </div>
          <div class="tri-gate-circle-container flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-gray-50 border border-gray-200/60 flex items-center justify-center transition-all duration-200" title="Awaiting execution">
              <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-[10px] text-gray-500 mt-2 text-center font-medium leading-tight" style="max-width: 64px;">Gate 2</div>
          </div>
          <div class="tri-gate-circle-container flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-gray-50 border border-gray-200/60 flex items-center justify-center transition-all duration-200" title="Awaiting execution">
              <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-[10px] text-gray-500 mt-2 text-center font-medium leading-tight" style="max-width: 64px;">Gate 3</div>
          </div>
        {{else if eq $refereeCount 1}}
          <div class="tri-gate-circle-container flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-gray-50 border border-gray-200/60 flex items-center justify-center transition-all duration-200" title="Pending">
              <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-[10px] text-gray-500 mt-2 text-center font-medium leading-tight" style="max-width: 64px;">—</div>
          </div>
          <div class="tri-gate-circle-container flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-gray-50 border border-gray-200/60 flex items-center justify-center transition-all duration-200" title="Pending">
              <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-[10px] text-gray-500 mt-2 text-center font-medium leading-tight" style="max-width: 64px;">—</div>
          </div>
        {{else if eq $refereeCount 2}}
          <div class="tri-gate-circle-container flex flex-col items-center">
            <div class="w-8 h-8 rounded-full bg-gray-50 border border-gray-200/60 flex items-center justify-center transition-all duration-200" title="Pending">
              <div class="w-2.5 h-2.5 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-[10px] text-gray-500 mt-2 text-center font-medium leading-tight" style="max-width: 64px;">—</div>
          </div>
        {{end}}
      {{end}}
    </div>
    {{if $isUniversalLaw}}
      <div class="mt-3 inline-flex items-center px-2 py-1 rounded-md bg-amber-50 border border-amber-200/60">
        <span class="text-[10px] font-semibold text-amber-700 uppercase tracking-wide">Universal Law</span>
      </div>
    {{end}}
  </td>

  <!-- Hypothesis -->
  <td class="px-6 py-5">
    <div class="text-sm font-medium text-gray-900 leading-snug">{{if .BusinessHypothesis}}{{if gt (len .BusinessHypothesis) 80}}{{substr .BusinessHypothesis 0 77}}...{{else}}{{.BusinessHypothesis}}{{end}}{{else}}{{.ID}}{{end}}</div>
    <div class="text-xs text-gray-500 mt-1.5 font-mono">{{.ID}}</div>
  </td>

  <!-- Tri-Gate Confidence -->
  <td class="px-6 py-5 whitespace-nowrap text-center">
    {{if .TriGateResult}}
      <div class="flex flex-col items-center">
        <div class="text-sm font-semibold {{if .TriGateResult.OverallPassed}}text-emerald-600{{else}}text-red-500{{end}}">
          {{printf "%.1f%%" (mul .TriGateResult.Confidence 100)}}
        </div>
        <div class="mt-1 inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-medium {{if .TriGateResult.OverallPassed}}bg-emerald-50 text-emerald-700 border border-emerald-200/60{{else}}bg-red-50 text-red-700 border border-red-200/60{{end}}">
          {{if .TriGateResult.OverallPassed}}PASSED{{else}}FAILED{{end}}
        </div>
      </div>
    {{else}}
      <div class="text-sm font-medium text-gray-400">—</div>
    {{end}}
  </td>

  <!-- P-Value (from first referee or aggregate) -->
  <td class="px-6 py-5 whitespace-nowrap text-center">
    {{if .RefereeResults}}
      {{$firstResult := index .RefereeResults 0}}
      {{if $firstResult.PValue}}
        <div class="text-sm font-semibold {{if lt $firstResult.PValue 0.001}}text-emerald-600{{else}}text-gray-900{{end}} font-mono">
          {{if lt $firstResult.PValue 0.001}}&lt;0.001{{else}}{{printf "%.3f" $firstResult.PValue}}{{end}}
        </div>
      {{else}}<span class="text-sm text-gray-400">—</span>{{end}}
    {{else}}<span class="text-sm text-gray-400">—</span>{{end}}
  </td>

  <!-- Sample Size (legacy support) -->
  <td class="px-6 py-5 whitespace-nowrap text-center">
    <div class="text-sm font-medium text-gray-900 font-mono">
      {{if .ExecutionMetadata.sample_size}}
        {{kfmt .ExecutionMetadata.sample_size}}
      {{else}}
        <span class="text-gray-400">—</span>
      {{end}}
    </div>
  </td>

  <!-- Actions -->
  <td class="px-6 py-5 whitespace-nowrap text-center">
    <button class="text-sm text-gray-700 hover:text-gray-900 font-medium transition-colors duration-150 hover:underline" onclick="toggleEvidenceDrawer('{{.ID}}')">
      {{if $isUniversalLaw}}Audit{{else}}Details{{end}}
    </button>
    {{if $isUniversalLaw}}
      <a href="/api/research/download/{{.ID}}" class="ml-3 text-xs text-gray-600 hover:text-gray-900 font-medium transition-colors duration-150 hover:underline" download>
        Export
      </a>
    {{end}}
  </td>
</tr>

<!-- Expandable Forensic Drawer -->
<tr id="drawer-{{.ID}}" class="bg-gray-50/30 hidden">
  <td colspan="6" class="px-6 py-6 border-t border-gray-200" style="width: 100%;">
    <div class="space-y-5" style="width: 100%; max-width: 100%;">
      <!-- Scientific Hypothesis -->
      <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
        <h4 class="text-xs font-semibold text-gray-600 mb-2.5 uppercase tracking-wider">Scientific Hypothesis</h4>
        <p class="text-gray-900 text-sm leading-relaxed">{{.ScienceHypothesis}}</p>
      </div>

      <!-- Null Case -->
      {{if .NullCase}}
      <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
        <h4 class="text-xs font-semibold text-gray-600 mb-2.5 uppercase tracking-wider">Null Hypothesis</h4>
        <p class="text-gray-700 text-sm leading-relaxed">{{.NullCase}}</p>
      </div>
      {{end}}

      <!-- Referee Selection Rationale (The Gavel) -->
      {{if .ExecutionMetadata}}
        {{$rationale := index .ExecutionMetadata "referee_selection_rationale"}}
        {{if $rationale}}
        <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
          <h4 class="text-xs font-semibold text-gray-600 mb-2.5 uppercase tracking-wider">Referee Selection Rationale</h4>
          <p class="text-gray-900 text-sm leading-relaxed">{{$rationale}}</p>
        </div>
        {{end}}
      {{end}}

      <!-- Tri-Gate Result Summary -->
      {{if .TriGateResult}}
      <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
        <h4 class="text-xs font-semibold text-gray-600 mb-4 uppercase tracking-wider">Tri-Gate Validation Summary</h4>
        <div class="grid grid-cols-2 gap-5 mb-4">
          <div>
            <span class="text-xs text-gray-500 uppercase tracking-wider font-medium">Overall Status</span>
            <div class="mt-2">
              {{if .TriGateResult.OverallPassed}}
                <span class="inline-flex items-center px-2.5 py-1 rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200/60 text-sm font-semibold">PASSED</span>
              {{else}}
                <span class="inline-flex items-center px-2.5 py-1 rounded-md bg-red-50 text-red-700 border border-red-200/60 text-sm font-semibold">FAILED</span>
              {{end}}
            </div>
          </div>
          <div>
            <span class="text-xs text-gray-500 uppercase tracking-wider font-medium">Confidence</span>
            {{$confPercent := mul .TriGateResult.Confidence 100.0}}
            <div class="mt-2 text-lg font-semibold text-gray-900">{{printf "%.1f%%" $confPercent}}</div>
          </div>
        </div>
        {{if .TriGateResult.Rationale}}
        <div class="mt-4 pt-4 border-t border-gray-200">
          <p class="text-sm text-gray-700 leading-relaxed">{{.TriGateResult.Rationale}}</p>
        </div>
        {{end}}
      </div>
      {{end}}

      <!-- Referee Evidence Cards -->
      {{if .RefereeResults}}
      <div>
        <h4 class="text-xs font-semibold text-gray-600 mb-4 uppercase tracking-wider">Forensic Evidence (Deca-Gate Execution)</h4>
        <div class="space-y-3">
          {{range $index, $result := .RefereeResults}}
          <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm hover:shadow transition-shadow duration-200">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2.5 mb-2">
                  <span class="text-sm font-semibold text-gray-900">{{$result.GateName}}</span>
                  {{if $result.Passed}}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200/60 text-xs font-medium">PASSED</span>
                  {{else}}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-red-50 text-red-700 border border-red-200/60 text-xs font-medium">FAILED</span>
                  {{end}}
                </div>
                {{if $result.StandardUsed}}
                <div class="text-xs text-gray-600 mt-1 font-mono leading-relaxed">{{$result.StandardUsed}}</div>
                {{end}}
              </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mt-4 pt-4 border-t border-gray-200">
              <div>
                <span class="text-xs text-gray-500 uppercase tracking-wider font-medium">Statistic</span>
                <div class="text-sm font-semibold text-gray-900 mt-1.5 font-mono">
                  {{if $result.Statistic}}
                    {{if eq $result.Statistic 0.0}}
                      <span class="text-gray-400">—</span>
                    {{else}}
                      {{printf "%.4f" $result.Statistic}}
                    {{end}}
                  {{else}}
                    <span class="text-gray-400">—</span>
                  {{end}}
                </div>
              </div>
              <div>
                <span class="text-xs text-gray-500 uppercase tracking-wider font-medium">P-Value</span>
                <div class="text-sm font-semibold {{if and $result.PValue (lt $result.PValue 0.001)}}text-emerald-600{{else}}text-gray-900{{end}} mt-1.5 font-mono">
                  {{if $result.PValue}}
                    {{if lt $result.PValue 0.001}}
                      &lt;0.001
                    {{else if ge $result.PValue 1.0}}
                      {{printf "%.4f" $result.PValue}}
                    {{else}}
                      {{printf "%.4f" $result.PValue}}
                    {{end}}
                  {{else}}
                    <span class="text-gray-400">—</span>
                  {{end}}
                </div>
              </div>
              <div>
                <span class="text-xs text-gray-500 uppercase tracking-wider font-medium">Threshold</span>
                <div class="text-sm font-semibold text-gray-900 mt-1.5 font-mono">
                  {{if $result.StandardUsed}}
                    {{/* Try to extract threshold from StandardUsed string */}}
                    {{if contains $result.StandardUsed "p ≤ 0.001"}}
                      α ≤ 0.001
                    {{else if contains $result.StandardUsed "p < 0.001"}}
                      α &lt; 0.001
                    {{else if contains $result.StandardUsed "p ≤ 0.05"}}
                      α ≤ 0.05
                    {{else if contains $result.StandardUsed "p < 0.05"}}
                      α &lt; 0.05
                    {{else}}
                      α ≤ 0.001
                    {{end}}
                  {{else}}
                    α ≤ 0.001
                  {{end}}
                </div>
              </div>
            </div>

            {{if and (not $result.Passed) $result.FailureReason}}
            <div class="mt-4 pt-4 border-t border-gray-200 bg-red-50/30 rounded-md p-3">
              <span class="text-xs font-semibold text-gray-700 uppercase tracking-wider">Kill Reason</span>
              <p class="text-sm text-gray-900 mt-1.5 leading-relaxed">{{$result.FailureReason}}</p>
            </div>
            {{end}}

            {{if $result.Passed}}
            <div class="mt-4 pt-4 border-t border-gray-200 bg-emerald-50/30 rounded-md p-3">
              <span class="text-xs font-semibold text-gray-700 uppercase tracking-wider">Validation Result</span>
              <p class="text-sm text-gray-900 mt-1.5 leading-relaxed">Referee passed all statistical checks. Hypothesis shows robust signal.</p>
            </div>
            {{end}}
          </div>
          {{end}}
        </div>
      </div>
      {{end}}

      <!-- Audit Trail Metadata -->
      {{if .StandardsVersion}}
      <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm">
        <div class="text-xs text-gray-600 font-medium">
          <span class="uppercase tracking-wider">Standards Version:</span> <span class="font-mono text-gray-900">{{.StandardsVersion}}</span> | 
          <span class="uppercase tracking-wider">Validated:</span> <span class="font-mono text-gray-900">{{.ValidationTimestamp.Format "2006-01-02 15:04:05"}}</span>
        </div>
      </div>
      {{end}}
    </div>
  </td>
</tr>
