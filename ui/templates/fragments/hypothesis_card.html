{{/* Hypothesis Row Template - Table Row Design with Tri-Gate Leading Indicator */}}
{{$isUniversalLaw := and .TriGateResult .TriGateResult.OverallPassed}}
<tr class="hover:bg-gray-50 transition-colors duration-150 border-b border-gray-300" data-hypothesis-id="{{.ID}}">
  <!-- Tri-Gate Leading Indicator -->
  <td class="px-4 py-4 whitespace-nowrap">
    <div class="flex items-center gap-2">
      {{if .RefereeResults}}
        {{/* Show referee status circles */}}
        {{range $index, $result := .RefereeResults}}
          {{if le $index 2}}
            <div class="tri-gate-circle-container" data-referee-index="{{$index}}">
              {{if $result.Passed}}
                <div class="w-6 h-6 border-2 border-gray-900 bg-white flex items-center justify-center" title="{{$result.GateName}}: PASSED">
                  <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </div>
              {{else}}
                <div class="w-6 h-6 border-2 border-gray-900 bg-white flex items-center justify-center" title="{{$result.GateName}}: FAILED{{if $result.FailureReason}} - {{$result.FailureReason}}{{end}}">
                  <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                </div>
              {{end}}
              <div class="text-xs text-gray-900 mt-1 text-center font-medium" style="max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                {{$result.GateName}}
              </div>
            </div>
          {{end}}
        {{end}}
        {{/* Fill remaining slots if less than 3 referees */}}
        {{$refereeCount := len .RefereeResults}}
        {{if eq $refereeCount 0}}
          <div class="tri-gate-circle-container">
            <div class="tri-gate-circle tri-gate-pending" title="Awaiting execution">
              <div class="w-3 h-3 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-xs text-gray-400 mt-1 text-center" style="max-width: 60px;">Gate 1</div>
          </div>
          <div class="tri-gate-circle-container">
            <div class="tri-gate-circle tri-gate-pending" title="Awaiting execution">
              <div class="w-3 h-3 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-xs text-gray-400 mt-1 text-center" style="max-width: 60px;">Gate 2</div>
          </div>
          <div class="tri-gate-circle-container">
            <div class="tri-gate-circle tri-gate-pending" title="Awaiting execution">
              <div class="w-3 h-3 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-xs text-gray-400 mt-1 text-center" style="max-width: 60px;">Gate 3</div>
          </div>
        {{else if eq $refereeCount 1}}
          <div class="tri-gate-circle-container">
            <div class="tri-gate-circle tri-gate-pending" title="Pending">
              <div class="w-3 h-3 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-xs text-gray-400 mt-1 text-center" style="max-width: 60px;">—</div>
          </div>
          <div class="tri-gate-circle-container">
            <div class="tri-gate-circle tri-gate-pending" title="Pending">
              <div class="w-3 h-3 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-xs text-gray-400 mt-1 text-center" style="max-width: 60px;">—</div>
          </div>
        {{else if eq $refereeCount 2}}
          <div class="tri-gate-circle-container">
            <div class="tri-gate-circle tri-gate-pending" title="Pending">
              <div class="w-3 h-3 rounded-full bg-gray-300"></div>
            </div>
            <div class="tri-gate-label text-xs text-gray-400 mt-1 text-center" style="max-width: 60px;">—</div>
          </div>
        {{end}}
      {{end}}
    </div>
    {{if $isUniversalLaw}}
      <div class="mt-2 text-xs font-semibold text-yellow-700 text-center">[LAW] Universal Law</div>
    {{end}}
  </td>

  <!-- Hypothesis -->
  <td class="px-6 py-4">
    <div class="text-sm font-medium text-gray-900">{{if .BusinessHypothesis}}{{if gt (len .BusinessHypothesis) 80}}{{substr .BusinessHypothesis 0 77}}...{{else}}{{.BusinessHypothesis}}{{end}}{{else}}{{.ID}}{{end}}</div>
    <div class="text-xs text-gray-500 mt-1">{{.ID}}</div>
  </td>

  <!-- Tri-Gate Confidence -->
  <td class="px-6 py-4 whitespace-nowrap text-center">
    {{if .TriGateResult}}
      <div class="text-sm font-semibold {{if .TriGateResult.OverallPassed}}text-green-600{{else}}text-red-600{{end}}">
        {{printf "%.1f%%" (mul .TriGateResult.Confidence 100)}}
      </div>
      <div class="text-xs text-gray-500 mt-1">{{if .TriGateResult.OverallPassed}}PASSED{{else}}FAILED{{end}}</div>
    {{else}}
      <div class="text-sm font-semibold text-gray-400">—</div>
    {{end}}
  </td>

  <!-- P-Value (from first referee or aggregate) -->
  <td class="px-6 py-4 whitespace-nowrap text-center">
    {{if .RefereeResults}}
      {{$firstResult := index .RefereeResults 0}}
      {{if $firstResult.PValue}}
        <div class="text-sm font-semibold {{if lt $firstResult.PValue 0.001}}text-green-600 font-bold{{else}}text-gray-900{{end}}">
          {{if lt $firstResult.PValue 0.001}}&lt;0.001{{else}}{{printf "%.3f" $firstResult.PValue}}{{end}}
        </div>
      {{else}}—{{end}}
    {{else}}—{{end}}
  </td>

  <!-- Sample Size (legacy support) -->
  <td class="px-6 py-4 whitespace-nowrap text-center">
    <div class="text-sm font-semibold text-gray-900">
      {{if .ExecutionMetadata.sample_size}}
        {{kfmt .ExecutionMetadata.sample_size}}
      {{else}}
        —
      {{end}}
    </div>
  </td>

  <!-- Actions -->
  <td class="px-6 py-4 whitespace-nowrap text-center">
    <button class="text-sm text-gray-900 hover:text-gray-700 font-bold underline" onclick="toggleEvidenceDrawer('{{.ID}}')">
      {{if $isUniversalLaw}}Audit{{else}}Details{{end}}
    </button>
    {{if $isUniversalLaw}}
      <a href="/api/research/download/{{.ID}}" class="ml-3 text-xs text-gray-900 hover:text-gray-700 font-bold underline" download>
        Export
      </a>
    {{end}}
  </td>
</tr>

<!-- Expandable Forensic Drawer -->
<tr id="drawer-{{.ID}}" class="bg-white hidden">
  <td colspan="6" class="px-6 py-4 border-t-2 border-gray-900" style="width: 100%;">
    <div class="space-y-6" style="width: 100%; max-width: 100%;">
      <!-- Scientific Hypothesis -->
      <div>
        <h4 class="text-sm font-bold text-gray-900 mb-2 uppercase tracking-wide">Scientific Hypothesis</h4>
        <p class="text-gray-900 text-sm leading-relaxed">{{.ScienceHypothesis}}</p>
      </div>

      <!-- Null Case -->
      {{if .NullCase}}
      <div>
        <h4 class="text-sm font-bold text-gray-900 mb-2 uppercase tracking-wide">Null Hypothesis</h4>
        <p class="text-gray-700 text-sm">{{.NullCase}}</p>
      </div>
      {{end}}

      <!-- Referee Selection Rationale (The Gavel) -->
      {{if .ExecutionMetadata}}
        {{$rationale := index .ExecutionMetadata "referee_selection_rationale"}}
        {{if $rationale}}
        <div class="bg-gray-100 border-2 border-gray-900 p-4">
          <h4 class="text-sm font-bold text-gray-900 mb-2 uppercase tracking-wide">Referee Selection Rationale</h4>
          <p class="text-gray-900 text-sm leading-relaxed">{{$rationale}}</p>
        </div>
        {{end}}
      {{end}}

      <!-- Tri-Gate Result Summary -->
      {{if .TriGateResult}}
      <div class="bg-white border-2 border-gray-900 p-4">
        <h4 class="text-sm font-bold text-gray-900 mb-3 uppercase tracking-wide">Tri-Gate Validation Summary</h4>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <span class="text-xs text-gray-600 uppercase tracking-wide font-bold">Overall Status</span>
            <div class="text-lg font-bold text-gray-900 mt-1">
              {{if .TriGateResult.OverallPassed}}<span class="text-green-600">[PASS]</span> PASSED{{else}}<span class="text-red-600">[FAIL]</span> FAILED{{end}}
            </div>
          </div>
          <div>
            <span class="text-xs text-gray-600 uppercase tracking-wide font-bold">Confidence</span>
            {{$confPercent := mul .TriGateResult.Confidence 100.0}}
            <div class="text-lg font-bold text-gray-900 mt-1">{{printf "%.1f%%" $confPercent}}</div>
          </div>
        </div>
        {{if .TriGateResult.Rationale}}
        <div class="mt-3 pt-3 border-t-2 border-gray-900">
          <p class="text-xs text-gray-700 font-medium">{{.TriGateResult.Rationale}}</p>
        </div>
        {{end}}
      </div>
      {{end}}

      <!-- Referee Evidence Cards -->
      {{if .RefereeResults}}
      <div>
        <h4 class="text-sm font-bold text-gray-900 mb-3 uppercase tracking-wide">Forensic Evidence (Deca-Gate Execution)</h4>
        <div class="space-y-3">
          {{range $index, $result := .RefereeResults}}
          <div class="bg-white border-2 border-gray-900 p-4">
            <div class="flex items-start justify-between mb-2">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-sm font-bold text-gray-900">{{$result.GateName}}</span>
                  {{if $result.Passed}}
                    <span class="inline-flex items-center px-2 py-1 border-2 border-gray-900 bg-white text-xs font-bold text-gray-900"><span class="text-green-600 mr-1">[PASS]</span> PASSED</span>
                  {{else}}
                    <span class="inline-flex items-center px-2 py-1 border-2 border-gray-900 bg-white text-xs font-bold text-gray-900"><span class="text-red-600 mr-1">[FAIL]</span> FAILED</span>
                  {{end}}
                </div>
                {{if $result.StandardUsed}}
                <div class="text-xs text-gray-700 mt-1 font-mono leading-relaxed">{{$result.StandardUsed}}</div>
                {{end}}
              </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mt-3 pt-3 border-t-2 border-gray-900">
              <div>
                <span class="text-xs text-gray-600 uppercase tracking-wide font-bold">Statistic</span>
                <div class="text-sm font-bold text-gray-900 mt-1">
                  {{if $result.Statistic}}
                    {{if eq $result.Statistic 0.0}}
                      —
                    {{else}}
                      {{printf "%.4f" $result.Statistic}}
                    {{end}}
                  {{else}}
                    —
                  {{end}}
                </div>
              </div>
              <div>
                <span class="text-xs text-gray-600 uppercase tracking-wide font-bold">P-Value</span>
                <div class="text-sm font-bold text-gray-900 mt-1">
                  {{if $result.PValue}}
                    {{if lt $result.PValue 0.001}}
                      &lt;0.001
                    {{else if ge $result.PValue 1.0}}
                      {{printf "%.4f" $result.PValue}}
                    {{else}}
                      {{printf "%.4f" $result.PValue}}
                    {{end}}
                  {{else}}
                    —
                  {{end}}
                </div>
              </div>
              <div>
                <span class="text-xs text-gray-600 uppercase tracking-wide font-bold">Threshold</span>
                <div class="text-sm font-bold text-gray-900 mt-1">
                  {{if $result.StandardUsed}}
                    {{/* Try to extract threshold from StandardUsed string */}}
                    {{if contains $result.StandardUsed "p ≤ 0.001"}}
                      α ≤ 0.001
                    {{else if contains $result.StandardUsed "p < 0.001"}}
                      α &lt; 0.001
                    {{else if contains $result.StandardUsed "p ≤ 0.05"}}
                      α ≤ 0.05
                    {{else if contains $result.StandardUsed "p < 0.05"}}
                      α &lt; 0.05
                    {{else}}
                      α ≤ 0.001
                    {{end}}
                  {{else}}
                    α ≤ 0.001
                  {{end}}
                </div>
              </div>
            </div>

            {{if and (not $result.Passed) $result.FailureReason}}
            <div class="mt-3 pt-3 border-t-2 border-gray-900 bg-gray-100 p-2">
              <span class="text-xs font-bold text-gray-900 uppercase tracking-wide">Kill Reason</span>
              <p class="text-sm text-gray-900 mt-1 leading-relaxed font-medium">{{$result.FailureReason}}</p>
            </div>
            {{end}}

            {{if $result.Passed}}
            <div class="mt-3 pt-3 border-t-2 border-gray-900 bg-gray-100 p-2">
              <span class="text-xs font-bold text-gray-900 uppercase tracking-wide">Validation Result</span>
              <p class="text-sm text-gray-900 mt-1 leading-relaxed font-medium">Referee passed all statistical checks. Hypothesis shows robust signal.</p>
            </div>
            {{end}}
          </div>
          {{end}}
        </div>
      </div>
      {{end}}

      <!-- Audit Trail Metadata -->
      {{if .StandardsVersion}}
      <div class="bg-gray-100 border-2 border-gray-900 p-3">
        <div class="text-xs text-gray-900 font-bold">
          <span class="uppercase tracking-wide">Standards Version:</span> {{.StandardsVersion}} | 
          <span class="uppercase tracking-wide">Validated:</span> {{.ValidationTimestamp.Format "2006-01-02 15:04:05"}}
        </div>
      </div>
      {{end}}
    </div>
  </td>
</tr>
