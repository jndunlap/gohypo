{{define "hypothesis_card_detailed"}}
{{$isUniversalLaw := and .Passed (ge .Confidence 0.8)}}
<div class="bg-white border-b border-gray-200 last:border-b-0" data-hypothesis-id="{{.ID}}">

    <!-- Hypothesis Header Block -->
    <div class="px-6 py-4 bg-white cursor-pointer hover:bg-gray-50 group select-none"
         data-hypothesis-id="{{.ID}}">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3 flex-1 min-w-0">
                <!-- Status Indicator -->
                <div class="w-2.5 h-2.5 rounded-full
                    {{if .Passed}}bg-green-500 group-hover:bg-green-700{{else if eq .Status "accepted"}}bg-green-500 group-hover:bg-green-700{{else if eq .Status "rejected"}}bg-red-500 group-hover:bg-red-700{{else}}bg-gray-400 group-hover:bg-gray-600{{end}}"
                    title="Status: {{if .Passed}}PASSED{{else if eq .Status "accepted"}}ACCEPTED{{else if eq .Status "rejected"}}REJECTED{{else}}PENDING{{end}}"></div>

                <!-- Hypothesis Content -->
                <div class="flex-1 min-w-0">
                    <span class="font-semibold text-gray-900 text-sm truncate block" title="{{if .BusinessHypothesis}}{{.BusinessHypothesis}}{{else}}{{.ID}}{{end}}">
                        {{if .BusinessHypothesis}}{{.BusinessHypothesis}}{{else}}{{.ID}}{{end}}
                    </span>
                    <span class="text-xs text-gray-600 block">{{.ID}}</span>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <!-- Status Badge -->
                <span class="text-xs font-semibold text-gray-900 bg-white px-2 py-1 rounded border border-gray-200">
                    {{if .Passed}}PASSED{{else if eq .Status "accepted"}}ACCEPTED{{else if eq .Status "rejected"}}REJECTED{{else}}PENDING{{end}}
                </span>
                <!-- Expand/Collapse Arrow -->
                <svg class="w-4 h-4 text-gray-600 group-hover:text-gray-900 hypothesis-arrow transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Expanded Details Block (Initially Collapsed) -->
    <div class="hypothesis-details hidden border-t border-gray-200">
        <div class="px-6 py-4 space-y-4">

            <!-- Validation Status -->
            <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-gray-600 uppercase tracking-wider">Validation Status</span>
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium {{if .Passed}}bg-green-50 text-green-700 border border-green-200{{else}}bg-red-50 text-red-700 border border-red-200{{end}}">
                    {{if .Passed}}PASSED{{else if eq .Status "accepted"}}ACCEPTED{{else if eq .Status "rejected"}}REJECTED{{else}}PENDING{{end}}
                </span>
            </div>

            <!-- Referee Results -->
            {{if .RefereeResults}}
            <div>
                <div class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-2">Referee Results</div>
                <div class="grid grid-cols-5 gap-2">
                    {{range $index, $result := .RefereeResults}}
                        {{if le $index 4}}
                        <div class="flex flex-col items-center">
                            {{if $result.Passed}}
                            <div class="w-6 h-6 rounded-full bg-green-50 border border-green-200 flex items-center justify-center" title="{{$result.GateName}}: PASSED">
                                <svg class="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            {{else}}
                            <div class="w-6 h-6 rounded-full bg-red-50 border border-red-200 flex items-center justify-center" title="{{$result.GateName}}: FAILED">
                                <svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            {{end}}
                            <div class="text-xs text-gray-600 mt-1 text-center truncate max-w-[50px]" title="{{$result.GateName}}">
                                {{$result.GateName}}
                            </div>
                        </div>
                        {{end}}
                    {{end}}
                </div>
            </div>
            {{end}}

            <!-- Statistics Grid -->
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-gray-50 rounded p-3 text-center border border-gray-200">
                    <div class="text-xs text-gray-600 uppercase tracking-wider font-medium mb-1">Confidence</div>
                    <div class="text-sm font-bold text-gray-900">
                        {{printf "%.0f" (mul .Confidence 100)}}%
                    </div>
                </div>
                <div class="bg-gray-50 rounded p-3 text-center border border-gray-200">
                    <div class="text-xs text-gray-600 uppercase tracking-wider font-medium mb-1">E-Value</div>
                    <div class="text-sm font-bold font-mono text-gray-900">
                        {{printf "%.2f" .CurrentEValue}}
                    </div>
                </div>
                <div class="bg-gray-50 rounded p-3 text-center border border-gray-200">
                    <div class="text-xs text-gray-600 uppercase tracking-wider font-medium mb-1">Sample Size</div>
                    <div class="text-sm font-bold font-mono text-gray-900">
                        {{if .ExecutionMetadata.sample_size}}N={{kfmt .ExecutionMetadata.sample_size}}{{else}}—{{end}}
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-between pt-2 border-t border-gray-200">
                <button class="text-sm text-gray-700 hover:text-gray-900 font-medium transition-colors duration-150"
                        hx-get="/api/hypothesis/{{.ID}}/evidence"
                        hx-target="#drawer-{{.ID}}"
                        hx-swap="innerHTML">
                    {{if $isUniversalLaw}}Audit{{else}}Details{{end}}
                </button>
                {{if $isUniversalLaw}}
                <a href="/api/research/download/{{.ID}}" class="text-sm text-gray-700 hover:text-gray-900 font-medium transition-colors duration-150" download>
                    Export
                </a>
                {{end}}
            </div>
        </div>
    </div>
</div>
<div id="drawer-{{.ID}}" class="mt-4 bg-white border border-gray-200 rounded-lg hidden">
  <div class="px-4 py-3 space-y-3">
    {{if .ScienceHypothesis}}
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <h4 class="text-sm font-semibold text-gray-900 mb-3">Scientific Hypothesis (H₁)</h4>
      <p class="text-gray-700 text-sm leading-relaxed">{{.ScienceHypothesis}}</p>
    </div>
    {{end}}
    {{if .NullCase}}
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <h4 class="text-sm font-semibold text-gray-900 mb-3">Null Hypothesis (H₀)</h4>
      <p class="text-gray-700 text-sm leading-relaxed">{{.NullCase}}</p>
    </div>
    {{end}}
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <h4 class="text-sm font-semibold text-gray-900 mb-4">E-value Validation Summary</h4>
      <div class="grid grid-cols-2 gap-6 mb-4">
        <div>
          <div class="text-sm text-gray-600 font-medium mb-2">Final Verdict</div>
          {{if .Passed}}
            <span class="inline-flex items-center px-3 py-1 rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200 text-sm font-semibold">ACCEPTED</span>
          {{else}}
            <span class="inline-flex items-center px-3 py-1 rounded-md bg-red-50 text-red-700 border border-red-200 text-sm font-semibold">REJECTED</span>
          {{end}}
        </div>
        <div>
          <div class="text-sm text-gray-600 font-medium mb-2">Confidence</div>
          <div class="text-lg font-semibold text-gray-900">{{printf "%.1f%%" (mul .Confidence 100)}}</div>
        </div>
      </div>
      <div class="pt-4 border-t border-gray-200">
        <p class="text-sm text-gray-700 leading-relaxed">E-value dynamic validation completed with {{len .RefereeResults}} referee{{if ne (len .RefereeResults) 1}}s{{end}} executed.</p>
      </div>
    </div>
    {{if .RefereeResults}}
    <div>
      <h4 class="text-sm font-semibold text-gray-900 mb-4">Forensic Evidence (Deca-Gate Execution)</h4>
      <div class="space-y-4">
        {{range $index, $result := .RefereeResults}}
        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow duration-200">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-3">
              <span class="text-sm font-semibold text-gray-900">{{$result.GateName}}</span>
              {{if $result.Passed}}
                <span class="inline-flex items-center px-2 py-1 rounded-md bg-emerald-50 text-emerald-700 border border-emerald-200 text-xs font-medium">PASSED</span>
              {{else}}
                <span class="inline-flex items-center px-2 py-1 rounded-md bg-red-50 text-red-700 border border-red-200 text-xs font-medium">FAILED</span>
              {{end}}
            </div>
          </div>

          {{if $result.StandardUsed}}
          <div class="text-sm text-gray-600 mb-4 font-mono bg-gray-50 p-2 rounded border">{{$result.StandardUsed}}</div>
          {{end}}

          <div class="grid grid-cols-3 gap-4 pt-4 border-t border-gray-200">
            <div>
              <div class="text-sm text-gray-600 font-medium mb-1">Statistic</div>
              <div class="text-sm font-semibold font-mono text-gray-900">
                {{if $result.Statistic}}
                  {{if eq $result.Statistic 0.0}}
                    <span class="text-gray-400">—</span>
                  {{else}}
                    {{printf "%.4f" $result.Statistic}}
                  {{end}}
                {{else}}
                  <span class="text-gray-400">—</span>
                {{end}}
              </div>
            </div>
            <div>
              <div class="text-sm text-gray-600 font-medium mb-1">P-Value</div>
              <div class="text-sm font-semibold font-mono text-gray-900">
                {{if $result.PValue}}
                  {{if lt $result.PValue 0.001}}
                    &lt;0.001
                  {{else}}
                    {{printf "%.4f" $result.PValue}}
                  {{end}}
                {{else}}
                  <span class="text-gray-400">—</span>
                {{end}}
              </div>
            </div>
            <div>
              <div class="text-sm text-gray-600 font-medium mb-1">Threshold</div>
              <div class="text-sm font-semibold font-mono text-gray-900">
                {{if $result.StandardUsed}}
                  {{if contains $result.StandardUsed "p ≤ 0.001"}}
                    α ≤ 0.001
                  {{else if contains $result.StandardUsed "p < 0.001"}}
                    α < 0.001
                  {{else if contains $result.StandardUsed "p ≤ 0.05"}}
                    α ≤ 0.05
                  {{else if contains $result.StandardUsed "p < 0.05"}}
                    α < 0.05
                  {{else}}
                    α ≤ 0.001
                  {{end}}
                {{else}}
                  α ≤ 0.001
                {{end}}
              </div>
            </div>
          </div>

          {{if and (not $result.Passed) $result.FailureReason}}
          <div class="mt-4 pt-4 border-t border-gray-200 bg-red-50 rounded-md p-3">
            <div class="text-sm font-semibold text-red-800 mb-1">Failure Reason</div>
            <p class="text-sm text-red-700 leading-relaxed">{{$result.FailureReason}}</p>
          </div>
          {{end}}

          {{if $result.Passed}}
          <div class="mt-4 pt-4 border-t border-gray-200 bg-emerald-50 rounded-md p-3">
            <div class="text-sm font-semibold text-emerald-800 mb-1">Validation Result</div>
            <p class="text-sm text-emerald-700 leading-relaxed">Referee passed all statistical checks. Hypothesis shows robust signal.</p>
          </div>
          {{end}}
        </div>
        {{end}}
      </div>
    </div>
    {{end}}
    {{if .StandardsVersion}}
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="text-sm text-gray-600">
        <span class="font-semibold">Standards Version:</span> <span class="font-mono text-gray-900">{{.StandardsVersion}}</span>
        <span class="mx-2 text-gray-400">•</span>
        <span class="font-semibold">Validated:</span> <span class="font-mono text-gray-900">{{.ValidationTimestamp.Format "2006-01-02 15:04:05"}}</span>
      </div>
    </div>
    {{end}}
  </div>
</div>
{{end}}
