{{define "workspace_sidebar"}}
<!-- Far Left Panel - Workspace Panel -->
<div id="workspace-panel" class="w-80 flex flex-col bg-white ">

    <!-- Header -->
    <div class="flex-shrink-0 border-b border-gray-200 bg-gray-100 text-black px-6 py-3 h-12">
        <div class="flex items-center justify-start">
            <h3 class="text-sm font-bold text-black uppercase tracking-wide">Workspaces</h3>
        </div>
    </div>

    <!-- Workspace List Container -->
    <div class="flex-1 overflow-y-auto border-r border-gray-200">
        <div id="workspace-list" class="space-y-0">
            <!-- Workspaces will be dynamically loaded here -->
            <div id="workspace-empty-state" class="text-center py-12 px-6">
                <div class="w-12 h-12 bg-gray-50 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                </div>
                <p class="text-sm font-medium text-gray-700 mb-1">No Workspaces Yet</p>
                <p class="text-xs text-gray-500">Create your first workspace</p>
            </div>
        </div>
    </div>

    <!-- Workspace Panel JavaScript -->
    <script>
        (function() {
            'use strict';
            
            try {
                console.log('[Workspace Sidebar] Script tag executing - workspace sidebar template loaded');
                console.log('[Workspace Sidebar] Current DOM state:', {
                    documentReady: document.readyState,
                    workspacePanelExists: !!document.getElementById('workspace-panel'),
                    workspaceListExists: !!document.getElementById('workspace-list')
                });
            } catch (e) {
                console.error('[Workspace Sidebar] Error in initial script execution:', e);
            }
        
            let expandedWorkspaces = new Set();
            let storedWorkspaces = new Map(); // Store workspace data by ID

            // Helper function to escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Function to add workspace to the panel
            function addWorkspaceToPanel(workspace) {
                if (!workspace?.id) {
                    console.error('[Workspace] Invalid workspace:', workspace);
                    return;
                }

                const workspaceName = workspace.name || '';
                const workspaceId = String(workspace.id).trim();
                const workspaceDesc = workspace.description || '';
                const workspaceColor = workspace.color || '#3B82F6';
                const createdAt = workspace.created_at || workspace.createdAt || '';

                const list = document.getElementById('workspace-list');
                const emptyState = document.getElementById('workspace-empty-state');

                if (!list) {
                    console.error('[Workspace] workspace-list element not found');
                    return;
                }

                // Hide empty state when first workspace is added
                if (emptyState && emptyState.style.display !== 'none') {
                    emptyState.style.display = 'none';
                }

                // Deselect current workspace
                deselectCurrentWorkspace();

                // Create workspace row element
                const workspaceRow = document.createElement('div');
                workspaceRow.className = 'workspace-row bg-white border-b border-gray-200 hover:bg-gray-50 cursor-pointer group select-none';
                workspaceRow.setAttribute('data-workspace-id', workspaceId);

                workspaceRow.innerHTML = `
                <div class="px-4 py-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <div class="w-2 h-2 rounded-full mt-1.5 flex-shrink-0 group-hover:ring-1 group-hover:ring-gray-300 group-hover:ring-opacity-50" style="background-color: ${workspaceColor}" title="Workspace color"></div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-900 leading-snug mb-1 truncate" title="${escapeHtml(workspaceName || workspaceId)}">
                                    ${escapeHtml(workspaceName || workspaceId)}
                                </div>
                                <div class="flex items-center space-x-3 text-xs text-gray-500">
                                    <span class="font-mono">${escapeHtml(workspaceId.substring(0, 8))}...</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 ml-2">
                            <button class="workspace-arrow-btn p-1 rounded hover:bg-gray-100 transition-colors duration-150 cursor-pointer" title="Toggle workspace details">
                                <svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600 workspace-arrow transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="workspace-details hidden transition-all duration-200 ease-in-out">
                    <div class="px-4 py-3">
                        <div class="space-y-2">
                            <div class="text-sm text-gray-700">
                                <strong class="text-gray-900">Name:</strong>
                                <div class="mt-1">${escapeHtml(workspaceName || 'Unnamed Workspace')}</div>
                            </div>
                            ${workspaceDesc ? `<div class="text-sm text-gray-700"><strong class="text-gray-900">Description:</strong><div class="mt-1">${escapeHtml(workspaceDesc)}</div></div>` : ''}
                            <div class="text-xs text-gray-500">Datasets: ${workspace.metadata?.max_datasets || 0} items</div>
                            ${createdAt ? `<div class="text-xs text-gray-500">Created: ${new Date(createdAt).toLocaleDateString()}</div>` : ''}
                        </div>
                    </div>
                </div>`;

                // Add event listeners
                workspaceRow.addEventListener('click', e => {
                    if (!e.target.closest('.workspace-action') && !e.target.closest('.workspace-arrow-btn')) {
                        selectWorkspace(workspaceId);
                    }
                });

                // Arrow button click handler
                const arrowBtn = workspaceRow.querySelector('.workspace-arrow-btn');
                if (arrowBtn) {
                    arrowBtn.setAttribute('title', 'Expand workspace details');
                    arrowBtn.addEventListener('click', e => {
                        e.stopPropagation(); // Prevent row selection
                        toggleWorkspaceRow(workspaceId);
                    });
                }

                workspaceRow.addEventListener('dblclick', () => toggleWorkspaceRow(workspaceId));

                // Store and add to DOM
                storedWorkspaces.set(workspaceId, workspace);
                list.appendChild(workspaceRow);

                console.log(`[Workspace] Added: ${workspaceName} (${workspaceId.substring(0, 8)}..., ${workspaceColor})`);
            }

            let selectedWorkspaceId = null;

            // Function to select a workspace
            function selectWorkspace(workspaceId) {
                const row = document.querySelector(`[data-workspace-id="${workspaceId}"]`);
                if (!row) return;

                // If already selected, deselect it
                if (selectedWorkspaceId === workspaceId) {
                    deselectCurrentWorkspace();
                    return;
                }

                // Deselect current selection first
                deselectCurrentWorkspace();

                // Select new workspace
                selectedWorkspaceId = workspaceId;
                row.classList.add('bg-gray-50', 'ring-1', 'ring-gray-200');
                const arrow = row.querySelector('.workspace-arrow');
                if (arrow) arrow.classList.add('text-gray-600');
                const statusDot = row.querySelector('.w-2.h-2');
                if (statusDot) statusDot.classList.add('bg-gray-500');

                // Dispatch selection event
                const workspace = getWorkspaceById(workspaceId);
                window.dispatchEvent(new CustomEvent('workspaceSelected', {
                    detail: { workspace: workspace }
                }));

                console.log('Selected workspace:', workspaceId);
            }

            // Function to deselect current workspace
            function deselectCurrentWorkspace() {
                if (!selectedWorkspaceId) return;

                const row = document.querySelector(`[data-workspace-id="${selectedWorkspaceId}"]`);
                if (row) {
                    row.classList.remove('bg-gray-50', 'ring-1', 'ring-gray-200');
                    const arrow = row.querySelector('.workspace-arrow');
                    if (arrow) arrow.classList.remove('text-gray-600');
                    const statusDot = row.querySelector('.w-2.h-2');
                    if (statusDot) statusDot.classList.remove('bg-gray-500');
                }

                const oldId = selectedWorkspaceId;
                selectedWorkspaceId = null;

                // Dispatch deselection event
                window.dispatchEvent(new CustomEvent('workspaceDeselected', {
                    detail: { workspaceId: oldId }
                }));

                console.log('Deselected workspace:', oldId);
            }

            // Function to get workspace data by ID
            function getWorkspaceById(workspaceId) {
                return storedWorkspaces.get(workspaceId) || null;
            }

            // Function to toggle workspace row expansion
            function toggleWorkspaceRow(workspaceId) {
                const row = document.querySelector(`[data-workspace-id="${workspaceId}"]`);
                if (!row) return;

                const details = row.querySelector('.workspace-details');
                const arrow = row.querySelector('.workspace-arrow');
                const arrowBtn = row.querySelector('.workspace-arrow-btn');

                if (expandedWorkspaces.has(workspaceId)) {
                    // Collapse
                    if (details) details.classList.add('hidden');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                    if (arrowBtn) arrowBtn.setAttribute('title', 'Expand workspace details');
                    expandedWorkspaces.delete(workspaceId);
                } else {
                    // Expand
                    if (details) details.classList.remove('hidden');
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                    if (arrowBtn) arrowBtn.setAttribute('title', 'Collapse workspace details');
                    expandedWorkspaces.add(workspaceId);
                }
            }


            // Function to clear all workspaces
            function clearWorkspacePanel() {
                const list = document.getElementById('workspace-list');
                const emptyState = document.getElementById('workspace-empty-state');

                if (!list) {
                    console.error('workspace-list element not found in clearWorkspacePanel!');
                    return;
                }

                // Deselect any selected workspace
                deselectCurrentWorkspace();

                // Remove all workspace rows
                const rows = list.querySelectorAll('.workspace-row');
                rows.forEach(row => row.remove());

                // Show empty state
                if (emptyState) {
                    emptyState.style.display = 'block';
                }

                // Clear expanded set and stored workspaces
                expandedWorkspaces.clear();
                storedWorkspaces.clear();

                console.log('[Workspace Sidebar] Cleared workspace panel:', {
                    rowsRemoved: rows.length,
                    storedWorkspacesCleared: storedWorkspaces.size,
                    expandedWorkspacesCleared: expandedWorkspaces.size
                });
            }

            // Initialize workspace panel
            function initializeWorkspacePanel() {
                const list = document.getElementById('workspace-list');
                if (!list) return;

                // Event listeners
                window.addEventListener('workspaceGenerated', e => {
                    if (e.detail?.workspace) addWorkspaceToPanel(e.detail.workspace);
                });
                window.addEventListener('workspacesCleared', clearWorkspacePanel);

                // Graph button
                const graphBtn = document.getElementById('workspace-graph-btn');
                if (graphBtn) {
                    graphBtn.addEventListener('click', () => {
                        const workspace = document.querySelector('.workspace-row');
                        const workspaceId = workspace?.getAttribute('data-workspace-id');
                        if (workspaceId) window.showWorkspaceGraph(workspaceId);
                    });
                }

                // Load workspaces
                loadWorkspacesInternal();
            }

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeWorkspacePanel);
            } else {
                initializeWorkspacePanel();
            }

            // Debug functions
            window.loadWorkspaces = () => loadWorkspacesInternal();
            window.testWorkspaceAPI = () => {
                fetch('/api/workspaces')
                    .then(r => r.ok ? r.json() : Promise.reject(r.status))
                    .then(d => console.log('[Workspace API Test]', d))
                    .catch(e => console.error('[Workspace API Error]', e));
            };

            // Function to load workspaces from API
            function loadWorkspacesInternal() {
                const list = document.getElementById('workspace-list');
                if (!list) {
                    setTimeout(loadWorkspacesInternal, 100);
                    return;
                }

                fetch('/api/workspaces')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        const workspaces = Array.isArray(data.workspaces) ? data.workspaces : [];

                        if (workspaces.length > 0) {
                            clearWorkspacePanel();
                            workspaces.forEach(workspace => {
                                try {
                                    addWorkspaceToPanel(workspace);
                                } catch (error) {
                                    console.error('[Workspace] Failed to add workspace:', error.message);
                                }
                            });
                            console.log(`[Workspace] Loaded ${workspaces.length} workspace(s)`);
                        } else {
                            clearWorkspacePanel();
                        }
                    })
                    .catch(error => {
                        console.error('[Workspace] Failed to load workspaces:', error.message);
                    });
            }
        })(); // End IIFE
    </script>

</div>
{{end}}