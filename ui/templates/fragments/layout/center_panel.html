{{define "center_panel"}}
<!-- Center Panel - Research Workspace -->
<div id="center-panel" class="flex-1 flex flex-col bg-white w-full max-w-none min-w-0 transition-all duration-300 ease-in-out">
    <!-- Research Header -->
    <div class="flex-shrink-0 border-b border-gray-200 bg-gray-50 p-3 h-12">
        <div class="flex items-center justify-start gap-2">
            <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wide">Research Engine</h3>
        </div>
    </div>

    <!-- Research Session Header -->
    <div class="border-b border-gray-200 bg-gray-50 px-6 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Research Session</h2>
                <p class="text-sm text-gray-600 mt-1" id="session-id">{{.SessionID}}</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="status-indicator status-active"></div>
                    <span class="text-sm text-gray-700">Active</span>
                </div>
                <button onclick="toggleSessionDetails()" class="flex items-center space-x-2 px-3 py-2 bg-white border border-gray-300 hover:bg-gray-50 transition-colors">
                    <span class="text-sm font-medium text-gray-700">Details</span>
                    <svg id="session-arrow" class="w-4 h-4 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-900" id="current-operation">Initializing research pipeline...</span>
                <span class="text-xs text-gray-500" id="operation-timestamp">--:--:--</span>
            </div>
            <div class="w-full bg-gray-200 h-1">
                <div id="operation-progress" class="bg-gray-900 h-1 transition-all duration-300" style="width: 10%"></div>
            </div>
            <div class="flex justify-between items-center mt-2">
                <span class="text-xs text-gray-600">Progress</span>
                <span class="text-xs font-medium text-gray-900" id="progress-percent">10%</span>
            </div>
        </div>

        <!-- Session Details -->
        <div id="session-details" class="mt-4 space-y-4" style="display: none;">
            <!-- AI Prompts -->
            <div class="border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-sm font-semibold text-gray-900">AI Research Prompts</h3>
                </div>
                <div class="p-4 space-y-4">
                    <!-- Greenfield Prompt -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-900">Greenfield Hypothesis Generator</span>
                            <button onclick="togglePromptBlock('greenfield')" class="ai-prompt-arrow">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="prompt-content-greenfield" style="display: none;">
                            <div class="text-xs text-gray-700 font-mono leading-relaxed whitespace-pre-wrap max-h-48 overflow-y-auto bg-gray-50 p-3 border border-gray-200">
{{.GreenfieldPrompt}}
                            </div>
                        </div>
                    </div>

                    <!-- Auditor Prompt -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-900">Statistical Validation Auditor</span>
                            <button onclick="togglePromptBlock('auditor')" class="ai-prompt-arrow">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="prompt-content-auditor" style="display: none;">
                            <div class="text-xs text-gray-700 font-mono leading-relaxed whitespace-pre-wrap max-h-48 overflow-y-auto bg-gray-50 p-3 border border-gray-200">
{{.LogicalAuditorPrompt}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Log -->
            <div class="border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-sm font-semibold text-gray-900">Research Timeline</h3>
                </div>
                <div class="p-4">
                    <div id="recent-events" class="space-y-2 max-h-48 overflow-y-auto text-sm text-gray-600">
                        <div class="text-center py-4">Session initialized - waiting for research to begin...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Field Selection Area -->
    <div id="field-selection-area" class="flex-shrink-0 border-b border-gray-200 bg-gray-50 px-6 py-4" style="display: none;">
        <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-semibold text-gray-900">Selected Fields</span>
            <button onclick="clearSelectedFields()" class="text-xs text-gray-600 hover:text-gray-900 transition-colors px-2 py-1 hover:bg-gray-200 rounded">
                Clear all
            </button>
        </div>
        <div id="selected-fields-container" class="flex flex-wrap gap-2">
            <!-- Selected field chips will appear here -->
        </div>
    </div>

    <!-- Research Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden bg-white">
        <!-- Research Content -->
        <div id="research-content" class="flex-1 overflow-y-auto">
            <!-- Initial State - Start Research -->
            {{if and .Datasets (not .Hypotheses)}}
            <div class="flex items-center justify-center min-h-full p-8">
                <div class="text-center max-w-lg">
                    <div class="w-16 h-16 bg-gray-900 flex items-center justify-center mx-auto mb-6">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-3">Research Engine</h1>
                    <p class="text-gray-600 mb-8 text-lg">Ready to analyze {{len .Datasets}} dataset{{if ne (len .Datasets) 1}}s{{end}} for hypothesis generation</p>
                    <form hx-post="/api/research/initiate" hx-target="#research-content" hx-swap="innerHTML">
                        <input type="hidden" name="workspace_id" value="{{if .WorkspaceID}}{{.WorkspaceID}}{{else}}550e8400-e29b-41d4-a716-446655440001{{end}}">
                        <button type="submit" class="bg-gray-900 hover:bg-gray-800 text-white font-medium py-4 px-8 text-lg transition-colors">
                            Start AI Research
                        </button>
                    </form>
                    <div id="research-status" class="mt-6"></div>
                </div>
            </div>
            {{else}}
            <!-- Research Results -->
            <div class="p-6 space-y-6">
                <!-- Research Summary -->
                <div class="border-b border-gray-200 pb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Research Results</h2>
                            <p class="text-sm text-gray-600 mt-1">Session {{.SessionID}}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">Status</div>
                            <div class="text-sm font-medium text-gray-900">Active</div>
                        </div>
                    </div>
                </div>

                <!-- Hypothesis Generation Control -->
                <div class="mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Hypothesis Generation</h3>
                            <p class="text-sm text-gray-600 mt-1">Use AI to analyze your data and generate business insights</p>
                        </div>
                        <button onclick="generateHypotheses()" id="generate-btn" class="bg-gray-900 hover:bg-gray-800 text-white font-medium py-3 px-6 text-sm transition-colors">
                            Generate Hypotheses
                        </button>
                    </div>
                </div>

                <!-- Hypotheses List -->
                <div id="hypotheses-container" class="space-y-4">
                    <div class="text-center py-12 text-gray-500" id="no-hypotheses-message">
                        <div class="w-12 h-12 bg-gray-100 flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </div>
                        <div class="text-lg font-medium">Ready to Generate Hypotheses</div>
                        <div class="text-sm mt-1">Click "Generate Hypotheses" to start AI analysis</div>
                    </div>
                </div>
            </div>
            {{end}}
        </div>

        <!-- Chat Input Area (Optional - for future user interactions) -->
        <div class="border-t border-gray-200 bg-white px-4 py-3" id="chat-input-area" style="display: none;">
            <div class="flex items-center space-x-3">
                <input type="text" placeholder="Ask about your research..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Send
                </button>
            </div>
        </div>
    </div>

        <!-- HTMX SSE for real-time research updates -->
        <div id="sse-connection" hx-sse="connect:/api/research/sse?session_id={{.SessionID}}"
             hx-sse-swap="hypothesis_pending:#hypothesis-cards-container:beforeend"
             hx-sse-swap="progress_update:#research-progress"
             class="hidden">
        </div>

        <style>
    /* Professional Clean Styling */
    #research-content {
        scroll-behavior: smooth;
    }

    /* Hypothesis Cards - Clean and Sharp */
    .hypothesis-card {
        border: 1px solid #e5e7eb;
        background: white;
        transition: border-color 0.15s ease;
    }

    .hypothesis-card:hover {
        border-color: #d1d5db;
    }

    .hypothesis-card.expanded {
        border-color: #10b981;
    }

    /* Clean Buttons */
    .btn-clean {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.15s ease;
    }

    .btn-clean:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    .btn-primary {
        background: #111827;
        border: 1px solid #111827;
        color: white;
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: background-color 0.15s ease;
    }

    .btn-primary:hover {
        background: #000000;
    }

    /* Status Indicators */
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 0;
        display: inline-block;
    }

    .status-active {
        background: #10b981;
    }

    .status-processing {
        background: #f59e0b;
        animation: pulse 2s infinite;
    }

    /* Clean Animations */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    /* Arrow Animations */
    .expand-arrow {
        transition: transform 0.15s ease;
    }

    .expanded .expand-arrow {
        transform: rotate(180deg);
    }

    /* Professional Typography */
    .text-professional {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        letter-spacing: -0.025em;
    }

    /* Clean Form Elements */
    input, textarea {
        border: 1px solid #e5e7eb;
        background: white;
        font-size: 0.875rem;
    }

    input:focus, textarea:focus {
        outline: none;
        border-color: #111827;
        box-shadow: 0 0 0 1px #111827;
    }

    /* AI Debug Panel Styles */
    .ai-prompt-arrow {
        transition: transform 0.2s ease;
    }

    /* JSON Syntax Highlighting */
    .language-json {
        color: #374151;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.75rem;
        line-height: 1.5;
    }

    .language-json .token.string { color: #059669; }
    .language-json .token.number { color: #dc2626; }
    .language-json .token.boolean { color: #7c3aed; }
    .language-json .token.null { color: #6b7280; }
    .language-json .token.punctuation { color: #374151; }
    .language-json .token.operator { color: #374151; }
    </style>

    <script>
        (function() {
            'use strict';

            // Store prompt content as JavaScript variables
            const greenfieldPrompt = `{{.GreenfieldPrompt}}`;
            const auditorPrompt = `{{.LogicalAuditorPrompt}}`;

        // ===== SSE CONNECTION MANAGEMENT =====

        let sseConnectionState = {
            connected: false,
            sessionId: '{{.SessionID}}',
            reconnectAttempts: 0,
            maxReconnectAttempts: 5,
            lastHeartbeat: Date.now(),
            heartbeatInterval: null
        };

        let circuitBreaker = {
            failures: 0,
            lastFailureTime: 0,
            state: 'closed',
            timeout: 60000,
            failureThreshold: 5
        };

        let connectionMetrics = {
            connectionAttempts: 0,
            failedConnections: 0
        };

        // ===== CONNECTION LIFECYCLE MANAGEMENT =====

        function startSSEHeartbeat() {
            if (sseConnectionState.heartbeatInterval) return;

            sseConnectionState.heartbeatInterval = setInterval(() => {
                const now = Date.now();
                const timeSinceLastHeartbeat = now - sseConnectionState.lastHeartbeat;

                // If no heartbeat for 30 seconds, consider connection dead
                if (timeSinceLastHeartbeat > 30000 && sseConnectionState.connected) {
                    console.warn('[SSE] Heartbeat timeout - connection may be dead');
                    handleSSEDisconnect();
                }
            }, 10000); // Check every 10 seconds
        }

        function stopSSEHeartbeat() {
            if (sseConnectionState.heartbeatInterval) {
                clearInterval(sseConnectionState.heartbeatInterval);
                sseConnectionState.heartbeatInterval = null;
            }
        }

        function handleSSEDisconnect() {
            sseConnectionState.connected = false;
            sseConnectionState.reconnectAttempts++;

            if (sseConnectionState.reconnectAttempts >= sseConnectionState.maxReconnectAttempts) {
                circuitBreaker.failures++;
                circuitBreaker.lastFailureTime = Date.now();

                if (circuitBreaker.failures >= circuitBreaker.failureThreshold) {
                    circuitBreaker.state = 'open';
                    setTimeout(() => {
                        circuitBreaker.state = 'half-open';
                        circuitBreaker.failures = 0;
                        attemptSSEReconnection();
                    }, circuitBreaker.timeout);
                }
                return;
            }

            const delay = Math.min(1000 * Math.pow(2, sseConnectionState.reconnectAttempts - 1), 30000);
            setTimeout(() => {
                if (circuitBreaker.state !== 'open') {
                    attemptSSEReconnection();
                }
            }, delay);
        }

        function attemptSSEReconnection() {
            console.log('[SSE] Attempting reconnection...');
            connectionMetrics.connectionAttempts++;

            try {
                // Force HTMX to re-establish SSE connection
                const sseElement = document.getElementById('sse-connection');
                if (sseElement) {
                    // Update the connection URL with current session
                    const newUrl = `/api/research/sse?session_id=${sseConnectionState.sessionId}&reconnect=${Date.now()}`;
                    sseElement.setAttribute('hx-sse', 'connect:' + newUrl);

                    // Trigger reconnection
                    htmx.process(sseElement);

                    // Set timeout for connection success
                    setTimeout(() => {
                        if (!sseConnectionState.connected) {
                            connectionMetrics.failedConnections++;
                            handleSSEDisconnect();
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('[SSE] Reconnection failed:', error);
                connectionMetrics.failedConnections++;
                handleSSEDisconnect();
            }
        }

        function handleSSEConnect() {
            sseConnectionState.connected = true;
            sseConnectionState.reconnectAttempts = 0;
            sseConnectionState.lastHeartbeat = Date.now();

            if (circuitBreaker.state === 'half-open') {
                circuitBreaker.state = 'closed';
            }

            startSSEHeartbeat();
        }

        function updateSessionContext(newSessionId) {
            if (sseConnectionState.sessionId !== newSessionId) {
                sseConnectionState.sessionId = newSessionId;
                if (sseConnectionState.connected) {
                    handleSSEDisconnect();
                } else {
                    attemptSSEReconnection();
                }
            }
        }

        // ===== EVENT HANDLING =====

        document.addEventListener('htmx:sseBeforeMessage', function(evt) {
            const event = evt.detail;
            sseConnectionState.lastHeartbeat = Date.now();

            if (event.data && event.data.session_id && event.data.session_id !== sseConnectionState.sessionId) {
                evt.preventDefault();
                return;
            }

            event.receivedAt = Date.now();
        });

        document.addEventListener('htmx:sseAfterMessage', function(evt) {
            const event = evt.detail;

            if (event.event === 'sse:connected' || event.event === 'connect') {
                handleSSEConnect();
            }

            if (event.event === 'session_created') {
                updateSessionStatus('Research session initialized', event.data.details || 'Starting AI analysis');
            }

            if (event.event === 'layer0_start') {
                updateResearchStatus('Analyzing data structure', 'Understanding field relationships');
            }

            if (event.event === 'layer2_start') {
                updateResearchStatus('Starting validation phase', 'Testing hypothesis robustness');
            }

            if (event.event === 'referee_completed') {
                updateResearchStatus('Validation completed', 'All statistical tests passed');
            }

            if (event.event === 'progress_update') {
                let operation = 'Processing...';
                let progress = 10;

                if (event.data && event.data.phase) {
                    if (event.data.phase.includes('Scout')) {
                        operation = 'Analyzing domain context';
                        progress = 20;
                    } else if (event.data.phase.includes('Analysis')) {
                        operation = 'Running statistical analysis';
                        progress = 40;
                    } else if (event.data.phase.includes('LLM')) {
                        operation = 'Generating hypotheses';
                        progress = 70;
                    } else if (event.data.phase.includes('Validation')) {
                        operation = 'Validating results';
                        progress = 90;
                    }
                }

                if (event.data && event.data.progress !== undefined) {
                    progress = Math.round(event.data.progress);
                }

                updateSessionStatus(operation, progress);
            }

            if (event.event === 'hypothesis_generated') {
                updateResearchStatus('Hypothesis generated', `Processing hypothesis ${event.data.sequence || 1}`);
                addHypothesis(event.data);
            }
        });

        document.addEventListener('htmx:sseError', function() {
            circuitBreaker.failures++;
            circuitBreaker.lastFailureTime = Date.now();
            handleSSEDisconnect();
        });

        document.addEventListener('htmx:sseClose', function() {
            sseConnectionState.connected = false;
            stopSSEHeartbeat();

            if (circuitBreaker.state !== 'open') {
                setTimeout(() => handleSSEDisconnect(), 1000);
            }
        });

        let hypothesisRefreshInterval = null;

        function startHypothesisRefresh() {
            if (hypothesisRefreshInterval) return;
            hypothesisRefreshInterval = setInterval(() => {
                const container = document.getElementById('hypothesis-cards-container');
                if (container && container.children.length > 0) {
                    fetch('/api/research/ledger?limit=50', { headers: { 'HX-Request': 'true' } })
                        .then(r => r.ok ? r.text() : Promise.reject(r))
                        .then(html => { container.innerHTML = html; })
                        .catch(() => showHypothesisError(container));
                }
            }, 2000);
        }

        function stopHypothesisRefresh() {
            if (hypothesisRefreshInterval) {
                clearInterval(hypothesisRefreshInterval);
                hypothesisRefreshInterval = null;
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            startSSEHeartbeat();

            const container = document.getElementById('hypothesis-cards-container');
            if (container && container.children.length > 0) {
                startHypothesisRefresh();
                setTimeout(stopHypothesisRefresh, 120000);
            }

            // Initialize session status
            updateSessionStatus('Session initialized');
        });

        // ===== HYPOTHESIS ERROR HANDLING =====

        function showHypothesisError(container) {
            if (!container) return;

            const errorHtml = `
                <div class="text-center py-12 px-6">
                  <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold text-gray-900 mb-1">Failed to Load Hypotheses</h3>
                  <p class="text-xs text-gray-600 mb-3">Unable to retrieve research hypotheses. Please try again.</p>
                  <button onclick="retryLoadHypotheses()"
                          class="inline-flex items-center px-3 py-1.5 bg-red-600 text-white text-xs font-medium rounded hover:bg-red-700 transition-colors">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Retry
                  </button>
                </div>
            `;
            container.innerHTML = errorHtml;
        }

        function retryLoadHypotheses() {
            const container = document.getElementById('hypothesis-cards-container');
            if (!container) return;

            // Show loading state
            container.innerHTML = `
                <div class="text-center py-12 px-6">
                  <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-gray-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                  </div>
                  <p class="text-sm font-semibold text-gray-700">Loading Hypotheses...</p>
                </div>
            `;

            // Retry the fetch
            fetch('/api/research/ledger?limit=50', {
                headers: {
                    'HX-Request': 'true'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(html => {
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('[UI] Retry failed to load hypotheses:', error);
                    showHypothesisError(container);
                });
        }

        function toggleSessionDetails() {
            const details = document.getElementById('session-details');
            const arrow = document.getElementById('session-arrow');

            const isExpanded = details.style.display !== 'none';

            if (isExpanded) {
                details.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                details.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            }
        }

        function togglePromptBlock(promptId) {
            const content = document.getElementById(`prompt-content-${promptId}`);
            const arrow = document.querySelector(`[onclick="togglePromptBlock('${promptId}')"] .ai-prompt-arrow`);

            const isExpanded = content.style.display !== 'none';

            if (isExpanded) {
                content.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(90deg)';
            }
        }

        // Expose functions to global scope for onclick handlers
        window.toggleSessionDetails = toggleSessionDetails;
        window.togglePromptBlock = togglePromptBlock;
        window.updateSessionStatus = updateSessionStatus;
        window.addRecentEvent = addRecentEvent;

        if (window.location.search.includes('debug=ai')) {
            setTimeout(() => toggleSessionDetails(), 1000);
        }

        window.AIDebug = {
            toggleDetails: toggleSessionDetails,
            showPrompts: () => {
                console.group('ðŸ¤– GoHypo AI Prompts');
                console.log('Greenfield Prompt:', greenfieldPrompt);
                console.log('Logical Auditor Prompt:', auditorPrompt);
                console.groupEnd();
            },
            togglePromptBlock: togglePromptBlock,
            updateStatus: updateSessionStatus,
            addEvent: addRecentEvent
        };


        // Update session status
        function updateSessionStatus(operation, progressPercent = null) {
            const operationSpan = document.getElementById('current-operation');
            const timestampSpan = document.getElementById('operation-timestamp');
            const progressBar = document.getElementById('operation-progress');
            const progressPercentSpan = document.getElementById('progress-percent');

            if (operationSpan) {
                operationSpan.textContent = operation;
            }

            if (timestampSpan) {
                const now = new Date();
                timestampSpan.textContent = now.toLocaleTimeString();
            }

            if (progressBar && progressPercent !== null) {
                progressBar.style.width = `${progressPercent}%`;
            }

            if (progressPercentSpan && progressPercent !== null) {
                progressPercentSpan.textContent = `${Math.round(progressPercent)}%`;
            }

            // Add to recent events
            addRecentEvent(operation);
        }

        function updateResearchStatus(message, details = '') {
            const statusDiv = document.getElementById('research-status');
            if (!statusDiv) return;

            statusDiv.innerHTML = `
                <div class="text-sm text-gray-600">
                    <div>${message}</div>
                    ${details ? `<div class="text-xs text-gray-500 mt-1">${details}</div>` : ''}
                </div>
            `;
        }

        function addHypothesis(hypothesisData) {
            const container = document.getElementById('hypotheses-container');
            if (!container) return;

            const hypothesisId = hypothesisData.id || `H${Date.now()}`;
            const sequence = hypothesisData.sequence || 1;

            const hypothesisCard = document.createElement('div');
            hypothesisCard.className = 'hypothesis-card p-6';
            hypothesisCard.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="status-indicator status-processing"></div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${hypothesisData.phenomenon_name || 'Business Insight'}</h3>
                            <p class="text-sm text-gray-600">Hypothesis ${sequence} â€¢ ${hypothesisId}</p>
                        </div>
                    </div>
                    <button onclick="toggleHypothesis('${hypothesisId}')" class="expand-arrow">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>

                <p class="text-gray-700 mb-4 leading-relaxed">${hypothesisData.business_hypothesis || 'Statistical pattern detected in your data'}</p>

                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center space-x-6">
                        <span class="text-gray-600">
                            <span class="font-medium">Strategic:</span> ${hypothesisData.opportunity_topology?.strategic_leverage || 'Medium'}
                        </span>
                        <span class="text-gray-600">
                            <span class="font-medium">Market:</span> ${hypothesisData.opportunity_topology?.market_implication || 'TBD'}
                        </span>
                    </div>
                    <span class="text-gray-500">${new Date().toLocaleTimeString()}</span>
                </div>

                <div class="hypothesis-details mt-4 pt-4 border-t border-gray-200" id="details-${hypothesisId}" style="display: none;">
                    <div class="space-y-4">
                        <div class="text-sm text-gray-700">
                            <strong>Scientific Foundation:</strong> This hypothesis is derived from statistical patterns in your dataset, validated through multiple testing methodologies.
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="validateHypothesis('${hypothesisId}')" class="btn-primary">
                                Validate
                            </button>
                            <button onclick="exportHypothesis('${hypothesisId}')" class="btn-clean">
                                Export
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(hypothesisCard);
        }

        function toggleHypothesis(hypothesisId) {
            const detailsEl = document.getElementById(`details-${hypothesisId}`);
            const cardEl = detailsEl.closest('.hypothesis-card');

            if (!detailsEl || !cardEl) return;

            const isExpanded = detailsEl.style.display !== 'none';

            if (isExpanded) {
                detailsEl.style.display = 'none';
                cardEl.classList.remove('expanded');
            } else {
                detailsEl.style.display = 'block';
                cardEl.classList.add('expanded');
            }
        }

        function validateHypothesis(hypothesisId) {
            updateResearchStatus(`Validating hypothesis ${hypothesisId}`, 'Running statistical tests...');
            // TODO: Trigger actual validation via API
        }

        function exportHypothesis(hypothesisId) {
            updateResearchStatus(`Exporting hypothesis ${hypothesisId}`, 'Generating report...');
            // TODO: Trigger actual export via API
        }

        function generateHypotheses() {
            const button = document.getElementById('generate-btn');
            const originalText = button.textContent;

            // Update button state
            button.textContent = 'Generating...';
            button.disabled = true;
            button.classList.add('opacity-50');

            // Update status
            updateResearchStatus('Generating hypotheses', 'AI is analyzing your data patterns');

            // Hide the no-hypotheses message
            const noHypothesesMsg = document.getElementById('no-hypotheses-message');
            if (noHypothesesMsg) {
                noHypothesesMsg.style.display = 'none';
            }

            // Make API call to generate hypotheses
            fetch('/api/research/generate-hypotheses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'HX-Request': 'true'
                },
                body: JSON.stringify({
                    session_id: '{{.SessionID}}'
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                updateResearchStatus('Hypotheses generated successfully', `${data.hypothesis_count || 0} insights created`);
            })
            .catch(error => {
                console.error('Failed to generate hypotheses:', error);
                updateResearchStatus('Generation failed', error.message);

                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                button.classList.remove('opacity-50');

                // Show error message
                const container = document.getElementById('hypotheses-container');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-red-500">
                            <div class="text-lg font-medium">Generation Failed</div>
                            <div class="text-sm mt-1">${error.message}</div>
                            <button onclick="generateHypotheses()" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 text-sm transition-colors">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            });
        }

        // Add event to recent events list
        function addRecentEvent(eventText) {
            const eventsDiv = document.getElementById('recent-events');
            if (!eventsDiv) return;

            const now = new Date();
            const timestamp = now.toLocaleTimeString();

            // Create new event item
            const eventItem = document.createElement('div');
            eventItem.className = 'text-xs text-slate-600 py-1 border-b border-slate-100 last:border-b-0';
            eventItem.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-slate-400">${timestamp}</span>
                    <span>${eventText}</span>
                </div>
            `;

            // Remove "No events yet..." if it exists
            const placeholder = eventsDiv.querySelector('.italic');
            if (placeholder) {
                placeholder.remove();
            }

            // Add new event at the top
            eventsDiv.insertBefore(eventItem, eventsDiv.firstChild);

            // Keep only last 10 events
            while (eventsDiv.children.length > 10) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }

        // Expose functions to global scope for onclick handlers
        window.togglePromptBlock = togglePromptBlock;

        window.SSEManager = {
            updateSessionContext,
            getConnectionState: () => sseConnectionState,
            getCircuitBreakerState: () => circuitBreaker,
            forceReconnect: attemptSSEReconnection
        };
        })();
        </script>

    </div>

    <!-- HTMX SSE for real-time event display -->
    <div id="research-events" hx-sse="connect:/api/research/sse"
         hx-sse-swap="research_event:#sse-events"
         class="hidden">
                </div>
</div>
{{end}}

