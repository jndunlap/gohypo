{{define "merge_modal"}}
<!-- Merge Modal -->
<div id="merge-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" style="display: none;">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Merge Datasets</h3>
                <button id="close-merge-modal" class="p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="px-6 py-6 overflow-y-auto max-h-96">
                <div class="mb-6">
                    <p class="text-sm text-gray-600 mb-6 leading-relaxed">
                        Combine multiple datasets into a single unified dataset. Choose your merge strategy based on data size and complexity.
                    </p>

                    <form id="merge-form" class="space-y-6">
                        <!-- Dataset Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-3">
                                Select Datasets to Merge
                            </label>
                            <div id="dataset-selector" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-md p-3">
                                <!-- Datasets will be loaded dynamically -->
                                <p class="text-sm text-gray-500">Loading datasets...</p>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">
                                Selected: <span id="selected-count">0</span> datasets
                            </p>
                        </div>

                        <!-- Output Configuration -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="merge-output-name" class="block text-sm font-medium text-gray-900 mb-2">
                                    Output Dataset Name
                                </label>
                                <input type="text"
                                       id="merge-output-name"
                                       name="output_name"
                                       placeholder="merged_dataset"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       required>
                            </div>
                            <div>
                                <label for="merge-workspace" class="block text-sm font-medium text-gray-900 mb-2">
                                    Target Workspace
                                </label>
                                <select id="merge-workspace" name="workspace_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <!-- Workspaces will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <!-- Merge Options -->
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-3">
                                Merge Options
                            </label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="merge-strategy" class="block text-sm text-gray-700 mb-1">
                                        Strategy
                                    </label>
                                    <select id="merge-strategy" name="strategy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="hybrid">Auto (Recommended)</option>
                                        <option value="in_memory">In-Memory (Fast, small datasets)</option>
                                        <option value="streaming">Streaming (Large datasets)</option>
                                        <option value="database">Database (Complex merges)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="merge-type" class="block text-sm text-gray-700 mb-1">
                                        Merge Type
                                    </label>
                                    <select id="merge-type" name="join_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="union">Union (Combine all rows)</option>
                                        <option value="inner">Inner Join (Matching keys)</option>
                                        <option value="left">Left Join (All from first)</option>
                                        <option value="outer">Outer Join (All rows)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div id="merge-progress" class="hidden">
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span id="merge-progress-text">Preparing merge...</span>
                                    <span id="merge-progress-percent">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="merge-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <div id="merge-status-messages" class="text-xs text-gray-600 space-y-1 max-h-20 overflow-y-auto">
                                    <!-- Status messages will be appended here -->
                                </div>
                            </div>
                        </div>

                        <div id="merge-result" class="text-sm"></div>
                    </form>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200">
                <button type="button" id="cancel-merge" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" form="merge-form" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" id="start-merge-btn">
                    Start Merge
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Merge modal functionality
let selectedDatasets = new Set();

// Override the global modal functions with merge modal implementations
window.showMergeModal = function() {
    loadDatasetsForMerge();
    loadWorkspacesForMerge();
    const modal = document.getElementById('merge-modal');
    if (modal) {
        modal.style.display = 'block';
        document.body.classList.add('overflow-hidden');
        if (window.resetMergeState) {
            window.resetMergeState();
        }
    }
};

window.hideMergeModal = function() {
    const modal = document.getElementById('merge-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('overflow-hidden');
    }
};

function resetMergeState() {
    selectedDatasets.clear();
    document.getElementById('merge-form').reset();
    document.getElementById('merge-progress').classList.add('hidden');
    document.getElementById('merge-result').innerHTML = '';
    document.getElementById('selected-count').textContent = '0';
    document.getElementById('merge-status-messages').innerHTML = '';
    updateSelectedCount();
}

function loadDatasetsForMerge() {
    fetch('/api/datasets/list')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('dataset-selector');
            if (!data.datasets || data.datasets.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No datasets available for merging</p>';
                return;
            }

            container.innerHTML = data.datasets.map(dataset => `
                <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox"
                           value="${dataset.id}"
                           class="dataset-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <div class="flex-1">
                        <div class="font-medium text-sm text-gray-900">${dataset.display_name || dataset.original_filename}</div>
                        <div class="text-xs text-gray-500">${dataset.record_count || 0} rows, ${dataset.field_count || 0} columns</div>
                    </div>
                </label>
            `).join('');

            // Add event listeners
            document.querySelectorAll('.dataset-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleDatasetSelection);
            });
        })
        .catch(error => {
            console.error('Failed to load datasets:', error);
            document.getElementById('dataset-selector').innerHTML = '<p class="text-sm text-red-600">Failed to load datasets</p>';
        });
}

function loadWorkspacesForMerge() {
    fetch('/api/workspaces')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('merge-workspace');
            select.innerHTML = '<option value="">Select workspace...</option>';

            if (data.workspaces && data.workspaces.length > 0) {
                data.workspaces.forEach(workspace => {
                    const option = document.createElement('option');
                    option.value = workspace.id;
                    option.textContent = workspace.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Failed to load workspaces:', error);
        });
}

function handleDatasetSelection(event) {
    const checkbox = event.target;
    const datasetId = checkbox.value;

    if (checkbox.checked) {
        selectedDatasets.add(datasetId);
    } else {
        selectedDatasets.delete(datasetId);
    }

    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selected-count').textContent = selectedDatasets.size;
}

function startMerge(event) {
    event.preventDefault();

    if (selectedDatasets.size < 2) {
        showMergeError('Please select at least 2 datasets to merge');
        return;
    }

    const formData = new FormData(document.getElementById('merge-form'));
    const outputName = formData.get('output_name');
    const workspaceId = formData.get('workspace_id');

    if (!outputName.trim()) {
        showMergeError('Please provide an output dataset name');
        return;
    }

    if (!workspaceId) {
        showMergeError('Please select a target workspace');
        return;
    }

    // Prepare merge request
    const mergeRequest = {
        dataset_ids: Array.from(selectedDatasets),
        output_name: outputName.trim(),
        workspace_id: workspaceId,
        merge_config: {
            strategy: formData.get('strategy') || 'hybrid',
            join_type: formData.get('join_type') || 'union'
        }
    };

    // Show progress
    document.getElementById('merge-progress').classList.remove('hidden');
    document.getElementById('start-merge-btn').disabled = true;
    document.getElementById('start-merge-btn').textContent = 'Merging...';

    // Start SSE monitoring
    startMergeProgressMonitoring(outputName);

    // Submit merge request
    fetch('/api/datasets/merge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(mergeRequest)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        showMergeSuccess('Merge operation started successfully!');
    })
    .catch(error => {
        console.error('Merge failed:', error);
        showMergeError('Failed to start merge operation: ' + error.message);
        document.getElementById('merge-progress').classList.add('hidden');
        document.getElementById('start-merge-btn').disabled = false;
        document.getElementById('start-merge-btn').textContent = 'Start Merge';
    });
}

function startMergeProgressMonitoring(mergeId) {
    const evtSource = new EventSource('/api/research/sse?session_id=merge-session');

    evtSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            if (data.dataset_id === mergeId) {
                updateMergeProgress(data.event_type, data.progress, data.message);

                if (data.event_type === 'merge_completed' || data.event_type === 'merge_failed') {
                    evtSource.close();
                    document.getElementById('start-merge-btn').disabled = false;
                    document.getElementById('start-merge-btn').textContent = 'Start Merge';

                    if (data.event_type === 'merge_completed') {
                        setTimeout(() => {
                            hideMergeModal();
                            window.location.reload();
                        }, 2000);
                    }
                }
            }
        } catch (e) {
            console.error('Error parsing merge SSE data:', e);
        }
    };

    evtSource.onerror = function(err) {
        console.error('Merge SSE error:', err);
        evtSource.close();
    };
}

function updateMergeProgress(eventType, progress, message) {
    const progressBar = document.getElementById('merge-progress-bar');
    const progressText = document.getElementById('merge-progress-text');
    const progressPercent = document.getElementById('merge-progress-percent');
    const statusMessages = document.getElementById('merge-status-messages');

    progressBar.style.width = progress + '%';
    progressPercent.textContent = Math.round(progress) + '%';
    progressText.textContent = message;

    // Add status message
    const messageDiv = document.createElement('div');
    messageDiv.textContent = message;
    messageDiv.className = 'text-xs';
    statusMessages.appendChild(messageDiv);
    statusMessages.scrollTop = statusMessages.scrollHeight;

    if (eventType === 'merge_failed') {
        progressBar.classList.remove('bg-blue-600');
        progressBar.classList.add('bg-red-600');
    } else {
        progressBar.classList.remove('bg-red-600');
        progressBar.classList.add('bg-blue-600');
    }
}

function showMergeError(message) {
    document.getElementById('merge-result').innerHTML =
        `<div class="p-3 bg-red-50 border border-red-200 rounded-md">
            <div class="flex items-center">
                <svg class="w-4 h-4 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <span class="text-sm text-red-800">${message}</span>
            </div>
        </div>`;
}

function showMergeSuccess(message) {
    document.getElementById('merge-result').innerHTML =
        `<div class="p-3 bg-green-50 border border-green-200 rounded-md">
            <div class="flex items-center">
                <svg class="w-4 h-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm text-green-800">${message}</span>
            </div>
        </div>`;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Modal controls
    document.getElementById('close-merge-modal')?.addEventListener('click', hideMergeModal);
    document.getElementById('cancel-merge')?.addEventListener('click', hideMergeModal);

    // Close modal when clicking outside
    document.getElementById('merge-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            hideMergeModal();
        }
    });

    // Form submission
    document.getElementById('merge-form')?.addEventListener('submit', startMerge);
});
</script>
{{end}}