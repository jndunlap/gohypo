{{template "base.html" .}}

{{define "content"}}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Dataset Intake</h1>
        <p class="mt-2 text-gray-600">Upload your data and verify analysis readiness</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left: Upload Section -->
        <div class="space-y-6">
            <!-- File Upload Card -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-upload mr-2 text-blue-600"></i>
                    Upload Dataset
                </h2>

                <form
                    hx-post="/api/datasets/upload"
                    hx-encoding="multipart/form-data"
                    hx-target="#upload-results"
                    hx-swap="innerHTML"
                    class="space-y-4">

                    <div>
                        <label for="dataset" class="block text-sm font-medium text-gray-700">
                            CSV File
                        </label>
                        <input
                            type="file"
                            id="dataset"
                            name="dataset"
                            accept=".csv"
                            required
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="mt-1 text-sm text-gray-500">
                            Upload a CSV file with headers. Maximum 100K rows, 50 columns.
                        </p>
                    </div>

                    <button
                        type="submit"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-upload mr-2"></i>
                        Upload & Analyze
                    </button>
                </form>

                <div id="upload-results" class="mt-4"></div>
            </div>

            <!-- Sample Dataset Card -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-flask mr-2 text-green-600"></i>
                    Try Sample Dataset
                </h2>
                <p class="text-gray-600 mb-4">
                    Experience GoHypo with our inspection compliance dataset.
                </p>
                <button
                    onclick="loadSampleDataset()"
                    class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-play mr-2"></i>
                    Load Sample Data
                </button>
            </div>
        </div>

        <!-- Right: Readiness Gates -->
        <div class="space-y-6">
            <!-- Readiness Status Card -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-check-circle mr-2 text-green-600"></i>
                    Analysis Readiness
                </h2>

                <div id="readiness-gates" class="space-y-3">
                    <div class="readiness-gate">
                        <div class="flex items-center">
                            <i class="fas fa-question-circle text-gray-400 mr-2"></i>
                            <span class="text-sm text-gray-600">Upload a dataset to check readiness</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column Inventory (will be populated after upload) -->
            <div class="bg-white shadow rounded-lg p-6 hidden" id="column-inventory">
                <h2 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-table mr-2 text-blue-600"></i>
                    Column Inventory
                </h2>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Column
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Type
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Missing %
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="column-rows">
                            <!-- Populated by HTMX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadSampleDataset() {
    // Simulate sample dataset loading
    fetch('/api/datasets/upload', {
        method: 'POST',
        body: new FormData(),
        headers: {
            'HX-Request': 'true'
        }
    }).then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        }
    });
}

// Update readiness gates based on upload
document.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.target.id === 'upload-results') {
        // Update readiness gates to show "analyzing..."
        document.getElementById('readiness-gates').innerHTML = `
            <div class="readiness-gate">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i>
                    <span class="text-sm text-gray-600">Analyzing dataset...</span>
                </div>
            </div>
        `;
    }
});
</script>
{{end}}
